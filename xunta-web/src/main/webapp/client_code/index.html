<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title></title>
		<link rel="shortcut icon" id="favicon_ico" type="image/x-icon" href="" media="screen" />
		<link rel="stylesheet" type="text/css" href="index_page/index.css"/>
		<link rel="stylesheet" type="text/css" href="login/login.css"/>
        <link rel="stylesheet" type="text/css" href="css/common_web.css"/>
        <link rel="stylesheet" type="text/css" href="css/popup.css"/>
        <link rel="prefetch" href="image/tractor.jpg" />
        <link rel="prefetch" id="prefetch_adminimage" href="" />
		<link rel="prefetch" id="prefetch_userimage" href="" />
        <meta property="qc:admins" content="650003246763061666375" />

		<!--让输入框的提示字颜色变淡 可以放到css里-->
		<style>
		::-webkit-input-placeholder { /* WebKit, Blink, Edge */	opacity:  0.2;	}
		:-moz-placeholder { /* Mozilla Firefox 4 to 18 */	opacity:  0.2;		}
		::-moz-placeholder { /* Mozilla Firefox 19+ */	opacity:  0.2;			}
		:-ms-input-placeholder { /* Internet Explorer 10-11 */	opacity:  0.2;	}
		</style>

	</head>
	<body>
		<div id="loadinganimation">
            <img src="image/tractor-short.gif" alt="Oops,进度条因网络不畅无法显示"/>
			<div id="loadingtext">
				正在登录...
			</div>
		</div>
		
		<div id="welcomepicture_container">
            <img id="welcome2" src="image/welcome2.png" />
		</div>
		
        <div id="mobilephone-login-container" >
        <div id="cancel_mobilelogin"><img src="image/goback5.png" style="height: 20px;width: 20px;float:left;margin: 5px;"				onclick="showLogin()"></div>
	        	<div id="countrycode">+86</div><input id="inputbox_mobileno"  value="请输入手机号" onfocus="if(this.value=='请输入手机号') {this.value=''}" onblur="if(this.value=='') {this.value='请输入手机号'}" onkeypress="inputMobile()" autofocus="autofocus"/> 
	        	<div id="button_checkonmobileno" onclick="checkonmobileno()"><div id="button_font">下一步</div></div>
	        	<div class="clear"></div>
	        	<div id="graphcode"><img src=""/><div id="changegraphcode" onclick="changGraphCode()">换一张</div></div>
	        	<div class="clear"></div>

				<div style="width:100%;height:27px">
	        	<input id="inputbox_graphcode" value="输入图形码" onfocus="if(this.value=='输入图形码') {this.value=''}" onblur="if(this.value=='') {this.value='输入图形码'}">
	        	<div id="button_requestSendSMSCode" onclick="requestSendSMSCode()"><div id="button_requestSendSMSCodefont">发送短信码</div></div>
	        	<div id="button_requestSendSMSCode4Resetpassword" onclick="requestSendSMSCode4Resetpassword()"><div id="button_requestSendSMSCode4Resetpasswordfont">发送短信码</div></div>
				</div>
	        	
	        	<input id="inputbox_smscode"  value="输入短信验证码" onfocus="if(this.value=='输入短信验证码') {this.value=''}" onblur="if(this.value=='') {this.value='输入短信验证码'}">
        		<input id="inputbox_nickname" value="输入昵称" onfocus="if(this.value=='输入昵称') {this.value=''}" onblur="if(this.value=='') {this.value='输入昵称'}">
        		<div class="clear"></div>
        		<input id="inputbox_password2login" value="输入登录密码" onfocus="if(this.value=='输入登录密码') {this.value='';this.type='password'}" onblur="if(this.value=='') {this.value='输入登录密码';this.type='text'}" style="display: inline;" onkeypress="if(event.keyCode==13){Javascript:loginbymobilephone()}">
        		<input id="inputbox_password2register" value="设置登录密码" onfocus="if(this.value=='设置登录密码') {this.value='';this.type='password'}" onblur="if(this.value=='') {this.value='设置登录密码';this.type='text'}" >
        		<input id="inputbox_resetpassword" value="重设登录密码" onfocus="if(this.value=='重设登录密码' && type='password') {this.value=''}" onblur="if(this.value=='') {this.value='重设登录密码';this.type='text'}" >        		<div id="forgetpassword" onclick="forgetPassword()">忘了</div>
        		<div id="button_registerbymobilephone" onclick="registerbymobilephone()"><div id="button_font">确认</div></div>
        		<div id="button_resetandloginbymobilephone" onclick="resetandloginbymobilephone()"><div id="button_font">重设密码并登录</div></div>
        		<div id="button_loginbymobilephone" onclick="loginbymobilephone()"><div id="button_font">登录</div></div>
        </div>
        
        <div id="login">
            <div>
                    <div title="微信" id="weixin_login" class="cursor" onclick="wx_login()"><img src="image/weixin-logo-gray2.png"/></div>
                </div>
            <div>
                <div title="QQ" id="qq_login" class="cursor" onclick="qq_login()"><img src="image/qq-logo-gray2.png"/></div>
            </div>
            <div>
                <div title="手机" id="mobilephone_login" class="cursor" onclick="show_mobilephoneloginform()"><img src="image/mobilephone1.jpg"/></div>
            </div>
        </div>
        <!--div id="login-text"> 这是登录按钮下面的文字,暂时备存.
                <div>
                    <div id="weixin_login_text">微信登录</div>
                </div>
                <div>
                    <div id="qq_login_text">QQ 登录</div>
                </div>
                <div>
                    <div id="mobilephone_login_text">手机登录</div>
                </div>
        </div-->
		<div id="logging" style="font-size:10px; display:none">
			<div id="return">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			</div>
			<!--logging记录栏-->
		</div>
		
		
		
		
	</body>
	<script type="text/javascript" src="script/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="script/sockjs-0.3.min.js"></script>
	<script type="text/javascript" src="script/websocket.js"></script>
	<script type="text/javascript" src="script/websocket_web.js"></script>
    <script type="text/javascript" src="login/login.js"></script>
    <script type="text/javascript" src="login/login_web.js"></script>
	<script type="text/javascript" src="script/common-xunta.js"></script>
	<script type="text/javascript" src="script/common-xunta_web.js"></script>
	<script type="text/javascript" src="script/version_update.js"></script>
    <script type="text/javascript" src="index_page/index_web.js"></script>
     <script type="text/javascript" src="index_page/index.js"></script>
     <script type="text/javascript" src="script/popup.js"></script>
     <!--2017.11.14 叶夷  微信JS-SDK是微信公众平台面向网页开发者提供的基于微信内的网页开发工具包。在需要调用JS接口的页面引入如下JS文件 -->
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
     
<!--body以上完全相同-->
	<script type="text/javascript">
        var userId;
        var userName;
        var userImage;
        var userInfo;//这是上面三个用户变量量打包后的Json包.
        
        var pageTitle;
		var adminName;
		var adminImageurl;
		var faviconUrl;
		var wxappid;
		var wxstate;
		var qqappid;
		var qqappkey;
		
        var projectType;
		var domain;
		var groupName;
        var userAgent;//web,这个变量为全局,供setIframeCSSifPCBrowser从openWin跨页调用时使用.
        var topicsPageOpenMark = "no";
          //下面这个变量必须放在这里,成为全局,因为domain的获得也与它有关:
		var isLocalTest=false;//在本地测试时,这个变量设为true.代码传到服务器时,要设为false;
        window.onload = start;//window.onload = readyMethod();//后面加括号是不对的,但是会造成什么问题还待查.xu 1.28

		function start(){ //0110 在body里的onload这个方法是什么意思? //qq微信登录成功后,会重新刷新index页面,再次从这里执行. 手机登录成功后,会在本地存储用户信息,然后回到这里.
			//log2root("开始进行JS-SDK验证");
			sendWeChatShareLinkMsg();	
			
			console.log("现在运行的是wolf 1版本.");
			userAgent = checkUserAgent();//返回一个数组["PC"或"Mobile","Android"或"QQBrowser"或"IE11"等]
			setBodyHeightWidth();
			//console.log("已设宽高......");
           	$("#loadinganimation").show();//显示拖拉机效果
			showLoadingtext(); //显示"正在.."文字
			$("#logging").hide(); //0110  这个logging可以完全去掉.
			$("#return").click(function() {//1.11 F 修改
				log2root("我点击了返回区.");
				//openWin('main_page', 'main_page/main_page.html', '');//?0110 todo openwin方法要重新定义. index.html暂时没移动
				$("iframe").show();
			});
			readXuntaConfigXml();//读取本地xunta-config.xml,为某些全局变量赋值.
			setPageTitle();//获得domain之后才能执行这一句.
			setPageICO();//设置页面顶部的小图标.
			setSpecialGroupReq();//只针对艾妮婚庆的主页面.
			//delayedCheckTopicListSuccess();//以是否成功获得topiclist为登录成功标志. 延时检查是否成功,如果不成功,则拖拉机停止.
			loginBegin();//进入login.js,成功获得userinfo则执行下面的userInfoIsReady(),出现问题则停止拖拉机或报错.
			/*
			var userinfo = getUserInfo();//读取本地用户信息,如果没有则进入登录过程.模拟帐号也在这里调用.//这里是马上返回的,promise机制没有起作用.
			if(userinfo != undefined){//除非是本地模拟帐号, 否则这里的userinfo一直是未定义. 在本地存储的条件下,也要向后台验证用户信息后才调用下面的userInfoIsReady().
				userInfoIsReady(userinfo);//获取话题列表成功后,userInfoIsReady()方法.
			}else{
				console.log("从getUserInfo()返回的userInfo是undefined!!!");
			}*/
			//window.onresize = setBodyHeightWidth();
			$(window).resize(function(){
				setBodyHeightWidth();
			}); 
		}
        
      function userInfoIsReady(userInfoStr){//本地已有用户信息,经服务器验证用户存在后,回到这里.
      	createPublicParam4UserInfo(userInfoStr);//获得用户信息后,为相关的公共变量赋值.
      	$("#prefetch_adminimage").attr("href", "image/"+adminImageurl);//预载管理员头像.  
        $("#prefetch_userimage").attr("href", userImage);//预载管理员头像.
      	//initToGetCP();//此时会自动创建ws连接. 获取话题列表成功后,将回调下面的initOpenTopicsPage()方法.
      	initOpenMainPage();
      	
      }
      
      function delayedCheckCPRequestSuccess(){//延时检查列表页是否成功,如果不成功,则中止拖拉机:
      	console.log("现在设置延时检测...");
      	setTimeout(
      		function(){	if(doRequestCP == true){//该变量在websocket.js中.等于true,说明列表页一直没有成功.
      			console.log("15秒后检查发现doRequestCP=true,说明列表页数据没有成功获取,停止拖拉机.");
				clickLoadingtextEvent();}      		
      		}
      	,10000);
      }
         	  
	  function initOpenMainPage(){//获取topiclist成功后,将回调到这个方法.
  			//deleteCookie();//到了这里登录过程才算完成了,这时删掉cookie.如果topiclist没有得到,刷新时cookie还能起作用.
	  		//console.log("topiclist===="+topiclist);
			var publicVars = publicVarsJson();
			var pageparam = {//准备openwin时的跨页参数:
				"publicVars":publicVars,
				//"topiclist":JSON.parse(topiclist)//topiclist本身是字串.这里parse一下,到新页面里就不用parse了.
			}
			console.log("pageparam---"+JSON.stringify(pageparam)); 	 
			console.log("打开main_page========"); 	 
			//pageparam = JSON.stringify(pageparam);
			//pageparam = JSON.stringify(pageparam);
			//pageparam = JSON.parse(pageparam);
			//pageparam = JSON.parse(pageparam);
			openNewWin('main_page', 'main_page/main_page.html', JSON.stringify(pageparam));//index.html暂时没移动
			//openWin('topics_page', 'topics_page/topics_page.html', pageparam);//index.html暂时没移动
				//1.11 新增 F
				//hideIndexLogInfo();
				$("#loadinganimation").hide();
				//?0110 这句移到调用处.
			browserOnlineOfflineEvent();
      }

	// 向服务器保存用户信息时使用的是ajax，若因断网等原因可能会导致数据没有返回来，这个时候利用拖拉机效果点击重新提交
	function clickLoadingtextEvent(){
    	setTimeout(function() {
        $("#loadinganimation img").attr('src', 'image/tractor.jpg');
        $("#loadingtext").text("网络不给力呀! 稍后戳一下拖拉机再试试.");
        $("#loadinganimation").click(function(evt) {
            //alert("点击了");
            $("#loadinganimation img").attr('src', 'image/tractor-short.gif');
            //恢复动态图片.
            $("#loadingtext").text("再次请求中...");
            //点击后马上取消这个事件绑定.
            $("#loadinganimation").unbind('click');
            start();
        });
    }, 5000);
}
	
	//2017.08.10 叶夷  监听输入手机号框的回车键
	function inputMobile(){
		if(event.keyCode==13){
			checkonmobileno();
			/*$("#inputbox_mobileno").blur();
			document.getElementById('inputbox_password2login').focus();
			console.log("测试： "+$("#inputbox_password2login").length);
			$("#inputbox_password2login").focus(); */
		}
	}
	
	function getLacalUrl(){
		//获取当前网址，如： http://localhost:8083/uimcardprj/share/meun.jsp
        var curWwwPath = window.document.location.href;
        //获取主机地址之后的目录，如： uimcardprj/share/meun.jsp
        var pathName = window.document.location.pathname;
        var pos = curWwwPath.indexOf(pathName);
        //获取主机地址，如： http://localhost:8083
        var localhostPaht = curWwwPath.substring(0, pos);
        //获取带"/"的项目名，如：/uimcardprj
        var projectName = pathName.substring(0, pathName.substr(1).indexOf('/') + 1);
       //console.log(":"+localhostPaht + projectName);
        return (localhostPaht + projectName);
	}
	
	/**2017.11.15 发送微信分享链接自定义消息给后台*/
	function sendWeChatShareLinkMsg(){
		var url= location.href.split('#').toString();
		console.log("发送微信分享链接自定义消息给后台");
		log2root("发送微信分享链接自定义消息给后台");
		
		$.ajax({
	        url : "http://www.xunta.so/xunta-web/sendShareLinksMsg",
	        action : "post",
	        contentType : "application/x-www-form-urlencoded; charset=utf-8",
	        dataType : "jsonp",
	        jsonp : 'callback',
	        jsonpCallback : "sendShareLinksMsg", //自定义的jsonp回调函数名称，默认为jQuery自动生成的随机函数名
	        data : {url:url },
	        async : false,
	        success : function(data, textStatus) {
	        	wx.config({
	                debug: false,////生产环境需要关闭debug模式
	                appId: "wxdac88d71df6be268",//appId通过微信服务号后台查看
	                timestamp: data.timestamp,//生成签名的时间戳
	                nonceStr: data.nonceStr,//生成签名的随机字符串
	                signature: data.signature,//签名
	                jsApiList: [//需要调用的JS接口列表
	                    'checkJsApi',//判断当前客户端版本是否支持指定JS接口
	                    'onMenuShareTimeline',//分享给好友
	                    'onMenuShareAppMessage'//分享到朋友圈
	                ]
	            });
	        	wx.ready(function () {
	        		//alert("微信JS-SDK成功");
	        		log2root("微信JS-SDK成功");
                	console.log("微信JS-SDK连接成功");
	        		
	                var link = "http://www.xunta.so/wxShareLinksLogin";
	                var imgUrl = getLacalUrl()+"/../image/xun.jpg";
	                var protocol = window.location.protocol;
	                var host = window.location.host;
	                //分享朋友圈
	                wx.onMenuShareTimeline({
	                    title: '寻Ta',
	                    link: link,
	                    imgUrl: imgUrl,// 自定义图标
	                    trigger: function (res) {
	                        // 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回.
	                        //alert('click shared');
	                    },
	                    success: function (res) {
	                        //alert('shared success'+link);
	                        //some thing you should do
	                    },
	                    cancel: function (res) {
	                        //alert('shared cancle'+link);
	                    },
	                    fail: function (res) {
	                        //alert(JSON.stringify(res));
	                    }
	                });

	    			//分享给好友
	              	wx.onMenuShareAppMessage({
            			title: '寻Ta', // 分享标题
            			desc: '发出"心语", 找到心灵相通的Ta', // 分享描述
           				link: link,
            			imgUrl:imgUrl, // 自定义图标
            			type: 'link', // 分享类型,music、video或link，不填默认为link
            			dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
            			success: function () {
            				alert('shared success'+imgUrl);
            			},
            			cancel: function () {
            				//alert('shared cancle'+link);
           				}
        			});
	                
	                wx.error(function (res) {
	                	//alert("微信JS-SDK连接失败");
	                	log2root("微信JS-SDK连接失败");
	                	console.log("微信JS-SDK连接失败");
	                });
	            });
	        },
	        error : function(data, textStatus) {
	        	//alert("微信JS-SDK验证信息获取失败");
	            console.log("微信JS-SDK验证信息获取失败");
	            log2root("微信JS-SDK验证信息获取失败");
	        }
	    });
	}
	</script>
</html>