<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="apple-mobile-web-app-capable" content="yes"/>
		<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
		<title>聊天页</title>
		<link rel="stylesheet" type="text/css" href="dialog_page.css"/>
		<link rel="stylesheet" type="text/css" href="dialog_page_web.css"/>
		<link rel="stylesheet" type="text/css" href="inputframe.css"/>
        <link rel="stylesheet" type="text/css" href="../css/popup.css"/>
        <link rel="stylesheet" type="text/css" href="../css/popcontext.css"/>
        <link rel="stylesheet" type="text/css" href="../css/common_web.css"/>
        <link rel="prefetch" href="../image/acclaim-50x173.png" />
        <link rel="prefetch" id="prefetch_adminimage" href="" />
		<link rel="prefetch" id="prefetch_userimage" href="" />

	</head>
	<!--下面的为元素库,与代码直接相关,不要作任何变动,运行时会hide掉-->		
	
		
<div id="e-lib">
	<div id="frame">
		<div class="user other">
			<div class="user-pic"><img src=""></div>
			<div class="nc"></div>
			<div class="detail">请点击选择并入到哪个话题:</div>
			<!--这里可以插入 <div class="mytopiclist"></div> -->
		</div>
	</div>
	<div class="mytopiclist" page="1">
	<!--这里插入 <div class="mytopic">1.话题1</div> -->
	</div>
	<div class="mytopic" onclick="">1.话题1</div>
</div>		
		
    <body>
	
	<div id="setupbox" style="margin-right: 5px;margin-top:1px;padding-top: 10px;padding-bottom: 12px">
	<div >
<input type="checkbox" value="true" id="private_topic" />
私密话题
<br />
<input type="checkbox" value="" id="topic_suspended" />
暂停使用

</div>
</br>
<div onclick="submitSetup()" id="submit_setup_button">确认</div>
<div onclick="cancelSetup()" id="cancel_setup_button">取消</div>
</div>

	
		<!--div id="notification">通知栏</div-->
		<div id="header">
			<div id="goback" onclick="backBtn()"><img src="../image/goback5.png" /></div>
			<div id="title" onclick="showWholeTitle()">[聊天页标题]	</div>
			<!--<div id="moretodoicon" onclick="showMoreToDo()"><img src="../image/moretodo_18.png" />	</div>-->
			<div class="_closeBtn" onclick="closeBtn()"><img src="../image/close.png" ></div>
		</div>
		
		<div id="wholetitlebox">
			<div id="wholetitle">This is the whole title.</div>
			<div id="changetitlebutton" onclick="changetitle()">修改</div>
		</div>
		<div id="moretodobox">
			<div id="topic_wrap">
				<div class="search_topic" onclick="enter_searchpage()">搜索</div>
			</div>
			<!-- 2017年5月26日  叶夷  为了域名判断按钮框的显示 加上ID值-->
			<div id="search_wrap">
				<div class="merge" id="mergeId1" onclick="relation.relation_pop()">关系</div>
				<div class="setup" onclick="enter_descendant()">邀请</div>
			</div>
			<div id="mergeplussetup_wrap">
				<div class="merge" id="mergeId2" onclick="click2RequestMyTopicList()">并入</div>
				<div class="setup" onclick="getSetupInfo()">设置</div>
			</div>
		</div>
		<div id="dialog_box">
			<div id="loadingwrap">
				<div id="loading"><img src="../image/threedotmoving.gif" />
					<div id="loadingtext">聊天记录加载中...</div>
				</div>
			</div>
			<div id="msg_list">
				<!-- 这里放入聊天内容-->
				<!-- 下面注释掉的样式为测试样板,不要删掉>			
				<div class="user other">
					<div class="user-pic"><img alt="" src="http://www.xunta.so/image?picId=QQuser_1D89B9B6D6E9ECF8B0016D61EB5FDE49_1432706452188.jpg"></div>
					<div class="nc">语擎</div>
					<div class="detail">请点击选择并入到哪个话题:	
					</div>
					<div class="whoistalking">
					<img src="http://wx.qlogo.cn/mmopen/USH8Nb3Hz5TOBhibHNJoKbMhheXXCypicu9W2JEHYKMgYr0G3KqJUw3JpmjgVkxc9l6T6aDG5EAbVsRaQkTqGibIKU4Pb35deu9/46">
					</div>
	

				</div-->
				
				
				
				<!--div class="user other">
					<div class="user-pic"><img alt="" src="http://www.xunta.so/image?picId=QQuser_1D89B9B6D6E9ECF8B0016D61EB5FDE49_1432706452188.jpg"></div>
					<div class="nc">语擎</div>
					<div class="detail recommend">请点击选择并入到哪个话题:	
						<img class="plus-logo" src="image/plus-20x20.png" />
					</div>
					<div class="mytopiclist">		
						<div class="mytopic">2.话题2        </div>
					</div>
				</div-->
			</div>
		</div>
		<div id="inputframe">
			<input type="text" id="inputbox" value="" onfocus="inputboxOnFocus(this)" onblur="inputboxOnBlur(this)" onkeypress="if(event.keyCode==13){Javascript:inputSubmit()}"/>
			<div id="inputsubmit" onclick="inputSubmit()" ><img src="../image/return9.png" /></div>
		</div>


		
		
		
	</body>
	<script type="text/javascript" src="../script/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="dialog_page_common.js"></script>
	<script type="text/javascript" src="dialog_page_common_web.js"></script>
    <script type="text/javascript" src="../script/common-xunta.js"></script>
    <script type="text/javascript" src="../script/common-xunta_web.js"></script>
    <script type="text/javascript" src="../script/popup.js"></script>
	<script type="text/javascript" src="../script/popcontext.js"></script>

	<script type="text/javascript">
		//叶夷  2017.07.13  聊天页中，将topic相关的信息先注释
		//var topicId = 'null';
		//var tmpTopicId = 'null';
		var userId;
		//var title = "";
		//var shortTitle;//用于发言中昵称后[]中的标题.
		var userName;	//直接上屏用得着.
        var userImage;	//直接上屏时用得着.
        
		var adminName;
		var adminImageurl;

		var _tmpPageId;
		var _topicPageSign;
        
        var lastPostTimeLongMinute = 0;
        var requestMsgCounts = 10;
        var firstMsgId = '-1';//用来记录话题分页消息的界点，
        var replyTopic = 'null';//用来在发言时判断是否要发送给指定的用户， 如果是的话则有指定用户的话题ID，如果不是的话为null FANG 10.12
        var domain;
        var sort;//记录上一次获取消息分页的排序，用在网络出现问题后接着获取用
        var isqingting;
        var userAgent;
        //adjustWidthsHeights();

		var connpage = 0;//当前连接话题页数
		var conncount = 20;//当前连接话题一页显示数据
		var relationordescendant = 0;//判断点的邀请(0)还是关系(1)
            
		var replySenderName = "";
		var replySenderNameWithTopic = "";
		var replyOppuid =  "";
		var replyOpptid = "";
        function start(Parameter){//web:在openWin时通过ready后回调,再跨页执行方式来启动的第一个方法.
            domain = Parameter.server_domain;
            //topicId = Parameter.topicid;
            userId = Parameter.userid;
            title = specialLettersDecoding(Parameter.title);
			shortTitle = cutStringIfTooLong(title,10);//标题长度如果大于7就要省略掉后面的////在显示聊天历史中也有这个判断.
            //console.log(title+"|"+shortTitle);
            userName = Parameter.userName;
            userImage = Parameter.userImage;
            
            adminName = Parameter.adminName;
            adminImageurl = Parameter.adminImageurl;
            userAgent = Parameter.userAgent;

			_tmpPageId = topicId;
			_topicPageSign = Parameter.topicPageSign;
			tmpTopicId = topicId;//2017.3.20 新增by Zheng
            
            $("#prefetch_adminimage").attr("href", "../image/"+adminImageurl);//预载管理员头像.  
        	$("#prefetch_userimage").attr("href", userImage);//预载管理员头像.
            
            isqingting = Parameter.isqingting;
            if(isqingting == 'yes'){
     		   $("#mergeplussetup_wrap").hide();
     		   $("#inputframe").remove();//倾听中取消输入框.
    		}
    		//暂时取消,换成下面两句:prepareDialogPage();
    		adjustWidthsHeights(isqingting);
    		showTitle();
    		sort = 'asc';
			//这里没几句,暂时移到了上面.方法暂时注销.prepareDialogPage();//
            execRoot("setCurrentPageId('"+topicId+"')");
            console.log("preparePageVars userImage="+userImage);
            execRoot("initToLoadPostHist('"+userId+"','"+topicId+"','"+firstMsgId+"','"+requestMsgCounts+"','"+sort+"')");
            
            //调用通过域名判断按钮框的显示的方法
            moretodoboxDisplayFromDomain();
        }

			
		function inputSubmit() {//初步处理提交的发言.
			var inputValue = verifyInputText();//如果输入内容不合法,将返回"invalidvalue".
			if (inputValue == "invalidvalue") return;
			afterInput(inputValue, "none");	//第二个参数为tmpPid.从输入框提交时为none.点击感叹号再次提交时则为有效tmpPid.
		}
		
		function inputSubmit1() {//初步处理提交的发言. //@wsy私聊窗口提交
			var inputValue1 = verifyInputText1();
			if(inputValue1 == "invalidvalue") return;
			$("#inputbox").val("@"+replySenderName+": "+inputValue1); //更新私聊对话框的值放入话题对话框
			afterInput1(inputValue1,"none");
			
			inputSubmit(); //@wsy 话题窗口提交
			$("#inputbox1").focus();

		}

		/**
		 *	聊天框页面返回功能   9.15 FANG
		 * 
		 * 在topic页面记录当前打开的聊天页面，如果在聊天页面回退到列表页面时，要将列表页面的记录值修改为Null,用来表示当前客户端没有正在浏览聊天窗口页面
		 * 
		 * 在聊天页面返回话题列表页面时要清空该话题的未读消息数
		 *  */
		function backButton() {
			//var elementInputBox = document.getElementById("inputbox");
			//$(elementInputBox).remove();//保持焦点,防止键盘收起.
			//console.log("执行了一下remove");
//			exec("topics_page","initCurrentOpenDialogPageId('"+topicId+"')");
            execRoot("setCurrentPageId('topics_page')");//设置列表页面为当前显示的页面ID
            exec('topics_page',"removeUnreadNum('"+topicId+"')");//删除列表页面该话题的未读消息数
            openWin('topics_page', 'topics_page/topics_page.html', '');//显示列表页
		}

		function stopLoadingIcon_getPostHist(isSuccess) {
			
			//停止动画图标.
			//console.log("历史消息,延时检查 停止loading图标 isSuccess:" + isSuccess);
			if (isSuccess) {//无事可做.
				console.log("历史消息,延时检查说成功了 对话页");
				$("#loading img").attr("src", "../image/threedotmoving.jpg");
			} else {
				console.log("历史消息,延时检查说没成功");
				$("#loadingtext").text("网络有点慢,等会儿点击这里再试试.");
				$("#loadingwrap").click(function(evt) {//填加再次请求的点击事件:
//					alert("点击了");
					$("#loading img").attr('src', '../image/threedotmoving.gif');//恢复动态图片.
					$("#loadingtext").text("再次请求中...");
                    window.parent.initToLoadPostHist(userId,topicId,firstMsgId,requestMsgCounts,sort);

					$("#loadingwrap").unbind('click');//点击后马上取消这个事件绑定.
				});
			}
		}
		
		//2017年5月26日  叶夷  通过域名判断按钮框的显示
		/**
			每个page的传递参数都有域名domain，根据domain区分访问网址，
			通过js使“并入”在xunta中不显示，改为显示新窗，“关系”改为显示屏蔽。
			这里的“新窗”和“屏蔽”都是调用原“关系”的模块,其他域名保持原样
		*/
		function moretodoboxDisplayFromDomain(){
			console.log("测试域名： "+domain);
			if(domain=="www.xunta.so"){
				var relative=document.getElementById("mergeId1");				
				relative.innerHTML="屏蔽";//"关系"变成"屏蔽"
				//relative.onclick=relation.relation_pop();//将并入的click方法清空再放入新窗的方法
				//relative.addEventListener('click', relation.relation_pop(), false);
				
				var merge=document.getElementById("mergeId2");
				merge.innerHTML="新窗";//“并入”变为“新窗”
				merge.onclick=function(){relation.relation_pop()};//将并入的click方法清空再放入新窗的方法
			}
			
		}
		//2017年5月27日  叶夷         监听安卓手机的返回键，按下返回键可以一步一步回退
		if (window.history && window.history.pushState) {
			$(window).on('popstate', function() { //监听浏览器回退键
				var hashLocation = location.hash;//hash 属性是一个可读可写的字符串，该字符串是 URL 的锚部分（从 # 号开始的部分）。
				var hashSplit = hashLocation.split("#!/");
				var hashName = hashSplit[1];
				if (hashName !== '') {
					var hash = window.location.hash;
					if (hash === '') {//这里填写的是点击回退键之后进行的操作
						backBtn();
					}
				}
			});

			/*
				意思就是把一个history记录插入到历史记录中。
				state：与要跳转到的URL对应的状态信息。
				title：页面标题。
				url：要跳转到的URL地址，不能跨域。
			*/
			window.history.pushState('forward', null, './#forward');//意思就是把一个history记录插入到历史记录中。
		}
	</script>
</html>