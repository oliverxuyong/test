<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="apple-mobile-web-app-capable" content="yes"/>
		<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
		<title>新创话题->聊天页</title>
		<link rel="stylesheet" type="text/css" href="dialog_page.css"/>
		<link rel="stylesheet" type="text/css" href="dialog_page_web.css"/>
		<link rel="stylesheet" type="text/css" href="inputframe.css"/>
        <link rel="stylesheet" type="text/css" href="../css/popup.css"/>
        <link rel="stylesheet" type="text/css" href="../css/popcontext.css"/>
        <link rel="stylesheet" type="text/css" href="../css/common_web.css"/>
        <link rel="prefetch" href="../image/acclaim-50x173.png" />
        <link rel="prefetch" id="prefetch_adminimage" href="" />
		<link rel="prefetch" id="prefetch_userimage" href="" />
	</head>
	<body>
	
		<div id="setupbox">
	<div >
<input type="checkbox" value="true" id="private_topic" />
私密话题
<br />
<input type="checkbox" value="" id="topic_suspended" />
暂停使用

</div>
</br>
<div onclick="submitSetup()" id="submit_setup_button">确认</div>
<div onclick="cancelSetup()" id="cancel_setup_button">取消</div>
</div>
	
	
	
		<!--div id="notification">通知栏</div-->
		<div id="header">
			<div id="moretodoicon"onclick="showMoreToDo()"><img src="../image/moretodo_18.png" />
			</div>
			<div id="goback" onclick="backButton()"><img src="../image/goback5.png" />
			</div>
			<div style="float:left">
				<div id="title">[聊天页标题]</div>
			</div>
		</div>
		<div id="wholetitlebox">
			<div id="wholetitle">wholetitle</div>
			<div id="changetitlebutton" onclick="changetitle()">修改</div>
		</div>		
		
		<div id="moretodobox" style="display: none">
				<div id="search" onclick="enter_searchpage()">搜    索</div>
				<div id="mergeplussetup_wrap">
					<div class="merge" onclick="click2RequestMyTopicList()">并入</div>
					<div class="setup" onclick="getSetupInfo()">设置</div>
				</div>
		</div>
		<div id="dialog_box">
			<div id="loadingwrap">
				<div id="loading"><img src="../image/threedotmoving.jpg" />
					<div id="loadingtext">你说,必有回应.</div>
				</div>
			</div>
			<div id="msg_list">
			<!-- 用来存放聊天内容-->
			</div>
			
		</div>
		<div id="inputframe">
			<input type="text" id="inputbox" value="" onfocus="inputboxOnFocus(this)" onblur="inputboxOnBlur(this)" onkeypress="if(event.keyCode==13){Javascript:inputSubmit()}"/>
			<div id="inputsubmit" onclick="inputSubmit()" ><img src="../image/return9.png" /></div>
		</div>
	
	<!--下面的为元素库,与代码直接相关,不要作任何变动,运行时会hide掉-->		
<div id="e-lib">
	<div id="frame">
		<div class="user other">
			<div class="user-pic"><img src=""></div>
			<div class="nc"></div>
			<div class="detail">请点击选择并入到哪个话题:</div>
			<!--这里可以插入 <div class="mytopiclist"></div> -->
		</div>
	</div>
	<div class="mytopiclist" page="1">
	<!--这里插入 <div class="mytopic">1.话题1</div> -->
	</div>
	<div class="mytopic" onclick="">1.话题1</div>
</div>		
		
		
		
	</body>
	<script type="text/javascript" src="../script/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="dialog_page_common.js"></script>
	<script type="text/javascript" src="dialog_page_common_web.js"></script>
    <script type="text/javascript" src="../script/common-xunta.js"></script>
    <script type="text/javascript" src="../script/common-xunta_web.js"></script>
    <script type="text/javascript" src="../script/popup.js"></script>
    <script type="text/javascript" src="../script/popcontext.js"></script>
	<script type="text/javascript">
		var topicId = 'null';	//正常的TID，如果不是创建话题页，他没有被赋值 9.15 FANG
		var tmpTopicId = 'null';
		var userId;
		var title = "";
		var shortTitle = "";
		var userName;	//直接上屏用得着.
		var userImage;	//直接上屏时用得着.
		var replyTopic = 'null';//用来在发言时判断是否要发送给指定的用户， 如果是的话则有指定用户的话题ID，如果不是的话为null FANG 10.12
		var domain;
		//^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^从列表页进入对话框所带来的参数 9.14 fang
		
		var adminName;
		var adminImageurl;
		var userAgent; 

		var firstMessage = true;
		var tmpTitle;
		var topicCreatedSuccess = false;//话题若没有创建成功，不允许用户发言 9.14 FANG
		var lastPostTimeLongMinute = 0;
		
		var replySenderName = "";
		var replySenderNameWithTopic = "";
		var replyOppuid =  "";
		var replyOpptid = "";

        function start(Parameter) {//web:在openWin时通过ready后回调,再跨页执行方式来启动的第一个方法.
            $("#moretodoicon").hide();
            title = "输入第一句,开始新话题…";
            domain = Parameter.server_domain;
            //topicId = Parameter.topicid;
            tmpTopicId = Parameter.tmptopicid;
            userId = Parameter.userid;
            userName = Parameter.userName;
            userImage = Parameter.userImage;	//用于直接上屏.
                        
            adminName = Parameter.adminName;
		    adminImageurl = Parameter.adminImageurl;
		    userAgent = Parameter.userAgent; 
		    
            execRoot("setCurrentPageId('"+tmpTopicId+"')");
            //暂时取消,换成下面两句:prepareDialogPage();
            adjustWidthsHeights(false);//参数应为isqingting,这个页面它一定是false.
    		showTitle();

            //console.log("preparePageVars userImage="+userImage);
            //console.log("preparePageVars title="+title);
			document.getElementById("inputbox").focus();//这是为了防止web版中别的页面打开后使这里得不到焦点.
        }

		/**
		 *	聊天框页面返回功能   9.15 FANG
		 *  */
		function backButton() {
            openWin('topics_page', 'topics_page/topics_page.html', '');//显示列表页
			execRoot("removeTmpTopicId('" + tmpTopicId + "')");
			execRoot("setCurrentPageId('topics_page')");//返回页面时要初始化话题列表页面的currentOpenDialogPageId变量,如果不初始化在回退到话题列表页时在没进入下一个聊天页面时，这时的消息如果发送到这里都会被认为已读，但实质上用户已经到了话题列表页 FANG 10.12
            exec("topics_page","removeUnreadNum('"+topicId+"')");//返回页面时要初始化话题列表页面的currentOpenDialogPageId变量,如果不初始化在回退到话题列表页时在没进入下一个聊天页面时，这时的消息如果发送到这里都会被认为已读，但实质上用户已经到了话题列表页 FANG 10.12
			closeWin(tmpTopicId);
        }
		
		
//====================================以上为web代码，以下为web/app共用代码===============================================================================================================================================================================================================================
		
		
		
		function showHitsRecommends(evntdata){
		//alert("收到  showHitsRecommends ...");
		//alert(evntdata.new_topicid+"|"+evntdata.hits+"|"+evntdata.recommend_num);
			var elib = $("#e-lib").clone();//不能在clone的元素上直接操作.
			var mytopiclistframe = elib.find("#frame");
			mytopiclistframe.find(".user-pic img").attr("src","../image/"+adminImageurl);
			mytopiclistframe.find(".nc").html(adminName);
			mytopiclistframe.find(".detail").html("有 <font color='blue'>"+evntdata.recommend_num+"</font> 位用户\"倾听\"了本话题.");
			$("#msg_list").append(mytopiclistframe.html());

			elib = $("#e-lib").clone();//不能在clone的元素上直接操作.
			mytopiclistframe = elib.find("#frame");
			mytopiclistframe.find(".user-pic img").attr("src","../image/"+adminImageurl);
			mytopiclistframe.find(".nc").html(adminName);
			var content = mytopiclistframe.find(".detail");
			if (evntdata.hits != 0){
				content.html("发现  <font color='blue'>"+evntdata.hits+" </font>个匹配话题, 不如去看看 -->");
                content.attr("class","detail cursor")
			}else{
				content.html("没有发现匹配话题. 试试搜索其它关键词 ->");
			}
			//content.click(function() {	enter_searchpage();	}); //不知为什么这句不灵! 改用下面一句绑定点击.
			content.attr("onclick","prepare_enter_searchpage()");
			$("#msg_list").append(mytopiclistframe.html());
			document.getElementById('dialog_box').scrollTop = document.getElementById('dialog_box').scrollHeight;
		}
		
		function prepare_enter_searchpage(){
			document.getElementById("inputbox").blur();//先收起键盘,防止进入搜索页时有一片空白.
			setTimeout(function(){enter_searchpage()},300);//没有function(){}延时不起作用.
		}

		function inputSubmit() {//初步处理提交的发言.
			var inputValue = verifyInputText();//如果输入内容不合法,将返回"invalidvalue".
			if (inputValue == "invalidvalue") return;
			//在话题没有创建成功时发出的消息是失败的，提示用户暂时不能发言 9.15 FANG
			if (!firstMessage && !topicCreatedSuccess) {
				comtomToast('报歉,第一句发言提交成功后才能接着发言.请点击它再试一下.',2000,'middle');
				return;
			} 
			afterInput4NewTopicPage(inputValue, "none");	//第二个参数为tmpPid.从输入框提交时为none.
		}

		function afterInput4NewTopicPage(inputValue, tmpPid) {//输入框提交到inputSubmit,然后到这里(此时tmpPid="none");感叹号直接提交都到这里(此时tmpPid!=none).
					
			if (topicCreatedSuccess == true) {	//到了这里就是正常发言了. 
				afterInput(inputValue, tmpPid);//这个afterInput()是几个聊天页的共用方法,以后移到dialog_page_common里.
			}else{//新话题还没有创建成功之前:
			//在第一句或未成功时点击感叹号时才会进到这里. 在未成功时,第二句是不让发出来的.xu9.29
				if (tmpPid == 'none') {//如果tmpPid为none,则表示从输入框的第一次提交.如果不是none,则是发送失败后,点击感叹号再次提交的.
					var tmpPid = new Date().getTime();	//生成临时发言id.
					tmpTitle = inputValue;//tmpTitle有什么用?
					//shortTitle = inputValue;//在第一句发言时,发言内容就是标题.
					shortTitle = cutStringIfTooLong(inputValue,10);
					firstMessage = false;
					showSelfPoster(inputValue, topicId, tmpPid);//消息直接上屏，并添加跳豆.
					console.log("创建新话题时首先从输入框的提交发言,tmpTitle和shortTitle都等于'发言'内容.");
				}else{//如果是从感叹号提交的, 可能要处理一下特殊字符
					console.log("初次失败后从感叹号再次提交发言,inputValue="+inputValue);
				}
				inputValue = specialLettersCoding(inputValue);//换成xunta专用代表字符串.
				execRoot("initCreateNewTopic('" + inputValue + "','" + tmpTopicId + "','" + tmpPid + "')");
				console.log('话题创建未成功状态, 新创话题的第一句话已发往服务器:' + inputValue);
			}
		}

		function afterInput_tmp将要删掉(inputValue, tmpPid) {//输入框提交到inputSubmit,然后到这里(此时tmpPid="none");感叹号直接提交都到这里(此时tmpPid!=none).
			if(inputValue == "660419"){//这句密码是为了打开index.html中的log记录.
				openWin('root','index.html');  //name : 'root', //openFrame下的名字参数不用写用frameName.
				return;
			}



				inputValue = specialLettersCoding(inputValue);//换成xunta专用代表字符串.
				if(replyTopic != 'null' & inputValue.indexOf(replySenderName) > -1){
                    var str = "initSendPoster_Reply2thistopic('" + replyTopic + "','" + inputValue + "','" + tmpPid + "','" + topicId + "')";
					execRoot(str);
                    replyTopic = 'null';
					sender_name = 'null';
				}else{
					var str = "initSendPoster('" + userId + "','" + inputValue + "','" + topicId + "','" + tmpTopicId + "','" + tmpPid + "')";//tmpTopicId这个时候的tmpTopicId应该是没用的了.
					execRoot(str);
				}


		}

function afterCheckedNewTopicSuccess(tmpPid, SendPosterSuccess) {//一般发言,新创话题,移动新建的延时检查处理都用这个方法.
	if (SendPosterSuccess) {
		alert(SendPosterSuccess);
		console.log("afterCheckedSendPosterSuccess 成功了,不作为");
	} else {//取消跳豆,加上感叹号,并绑定点击再请求的事件:
		console.log("afterCheckedSendPosterSuccess 失败, 取消跳豆,加上感叹号.");
		var thePosterElement = $("#dialog_box").find("#" + tmpPid);
		thePosterElement.find(".postsending").attr('src', "../image/acclaim-50x173.png");
		thePosterElement.click(function() {
			var thePosterElementObj = $("#dialog_box").find("#" + tmpPid);
			thePosterElementObj.find(".postsending").attr('src', '../image/jumpingbean.gif');
			afterInput4NewTopicPage(thePosterElement.find(".detail").text(), tmpPid);
			//发言再次发送后, 后台要判断一下tmpPid是否已经发过了,如果有,,则返回原来的topicid和内容.否则会重复.
			thePosterElement.unbind('click');
		});
	}
}


		//创建话题请求成功的状态标记   9.15 FANG //movetonewtopic成功后,也用这个方法标记成功.
		function markNewTopicSuccess(eventdata) {// FANG 直接把服务器返回的json对象传进来了，否则还要一个个的获取参数，比较麻烦 9.21
			$("#loading img").attr("src", "../image/threedotmoving.jpg");
			$("#loadingtext").text("话题创建成功.");
			$("#moretodoicon").show();
			$("#title").attr("onclick","showWholeTitle()");
//			<div id="title" onclick="showWholeTitle()">[聊天页标题]</div>
			//console.log("markNewTopicSuccess msg=");
			
			topicCreatedSuccess = true;
			topicId = eventdata.topicid;
			title = tmpTitle;
			shortTitle = cutStringIfTooLong(title,10);//标题长度如果大于7就要省略掉后面的////在显示聊天历史中也有这个判断.
			showTitle(title);
			/*
			$("#searching").text("["+title+"]已被推荐给N个用户,请耐心等待回应. 或者主动搜索他人话题.");
			$("#searching").click(
				function () {
					enter_searchpage();
				}			
			);*/ 
			
			//------------------------------------房  9.21
			/**
			 *	获取服务器返回来的json消息，编辑上屏消息
			 * 	1、将服务器返回来的消息ID替换掉聊天框里的消息临时ID
			 * 	2、取消黑色跳豆的状态，因为话题已创建成功
			 * 	3、添加服务器返回来的时间
			 *  */
			var pid = eventdata.pid;			//获取服务器返回来的正式消息ID。
			var tmpPid = eventdata.tmp_pid;
			var postTimeStr = eventdata.poster_create_datetime_str;
			var postTimeLongMinute = eventdata.poster_create_datetime_long / 1000 / 60;//将时间转换成 月日 时分
			markSendPosterSuccess(tmpPid,pid,postTimeLongMinute,postTimeStr);

			var time = postTimeStr.substring(5, 16);
			//话题创建成功后，将话题显示在话题列表页上
			var script = "appendElement('" + title + "','" + topicId + "','new','" + time + "','post_topic','" + userName + "','" + tmpTitle + "','0')";
			exec("topics_page", script);	//			 *	将消息显示到话题列表页面最新回复消息  9.21 FANG
		}
		//2017年5月27日  叶夷         监听安卓手机的返回键，按下返回键可以一步一步回退
		if (window.history && window.history.pushState) {
			$(window).on('popstate', function() { //监听浏览器回退键
				var hashLocation = location.hash;//hash 属性是一个可读可写的字符串，该字符串是 URL 的锚部分（从 # 号开始的部分）。
				var hashSplit = hashLocation.split("#!/");
				var hashName = hashSplit[1];
				if (hashName !== '') {
					var hash = window.location.hash;
					if (hash === '') {//这里填写的是点击回退键之后进行的操作
						backButton();
					}
				}
			});

			/*
				意思就是把一个history记录插入到历史记录中。
				state：与要跳转到的URL对应的状态信息。
				title：页面标题。
				url：要跳转到的URL地址，不能跨域。
			*/
			window.history.pushState('forward', null, './#forward');//意思就是把一个history记录插入到历史记录中。
		}

	</script>
</html>