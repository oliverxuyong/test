<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
	<title>新窗->聊天页</title>
	<link rel="stylesheet" type="text/css" href="dialog_page.css"/>
	<link rel="stylesheet" type="text/css" href="dialog_page_web.css"/>
	<link rel="stylesheet" type="text/css" href="dialog_page_movetonewtopic.css"/>
	<link rel="stylesheet" type="text/css" href="inputframe.css"/>
	<link rel="stylesheet" type="text/css" href="../css/popup.css"/>
	<link rel="stylesheet" type="text/css" href="../css/common_web.css"/>
</head>
<body>

<div id="setupbox">
	<div >
		<input type="checkbox" value="true" id="private_topic" />
		私密话题
		<br />
		<input type="checkbox" value="" id="topic_suspended" />
		暂停使用

	</div>
	</br>
	<div onclick="submitSetup()" id="submit_setup_button">确认</div>
	<div onclick="cancelSetup()" id="cancel_setup_button">取消</div>
</div>

<!--div id="notification">通知栏</div-->
<div id="header">
	<div id="moretodoicon"onclick="showMoreToDo()"><img src="../image/moretodo_18.png" />
	</div>
	<div id="goback" onclick="backButton()"><img src="../image/goback5.png" />
	</div>
	<div style="float:left">
		<div id="title" onclick="showWholeTitle()">[聊天页标题]</div>
	</div>
</div>
<div id="wholetitlebox">
	<div id="wholetitle">wholetitle wholetitle wholetitlewholetitlew holetitlewholetitlewhol etitlewholetitlewholetitlewho letitlewholetitlewholetitle</div>
	<div id="changetitlebutton" onclick="changetitle()">修改</div>
</div>



<div id="moretodobox" >
	<div id="search" onclick="enter_searchpage()">搜    索</div>
	<div id="mergeplussetup_wrap">
		<div class="merge" onclick="click2RequestMyTopicList()">并入</div>
		<div class="setup" onclick="getSetupInfo()">设置</div>
	</div>
</div>

<div id="dialog_box">


	<div id="msg_list">

		<div id="move2existedtopic" onclick="click2RequestMyTopicList_4moveto()">
			<div class="wording cursor">直接把Ta的[话题]接入我的另一个话题 </div>
			<img class="cursor" src="../image/u417.png"></img>
		</div>
		</br>
		</br>
		</br>
		</br>
		</br>
		</br>
		</br>
		</br>

		<!-- 用来存放聊天内容-->

		<div id="messagelist">
			<div class="from_user user other">
				<div class="nc"></div>
				<div class="detail"></div>
				<div class="user-pic"><img /></div>
				</br>
				</br>
			</div>
		</div>
	</div>

</div>
<div id="inputframe">
	<input type="text" id="inputbox" value="" onfocus="inputboxOnFocus(this)" onblur="inputboxOnBlur(this)" onkeypress="if(event.keyCode==13){Javascript:inputSubmit()}"/>
	<div id="inputsubmit" onclick="inputSubmit()" ><img src="../image/return9.png" /></div>
</div>

<!--下面的为元素库,与代码直接相关,不要作任何变动,运行时会hide掉-->
<div id="e-lib">
	<div id="frame">
		<div class="user other">
			<div class="user-pic"><img src=""></div>
			<div class="nc"></div>
			<div class="detail">请点击选择接入到哪个话题:</div>
			<!--这里可以插入 <div class="mytopiclist"></div> -->
		</div>
	</div>
	<div class="mytopiclist" page="1">
		<!--这里插入 <div class="mytopic">1.话题1</div> -->
	</div>
	<div class="mytopic" onclick="">1.话题1</div>
</div>

</body>
<script type="text/javascript" src="../script/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="dialog_page_common.js"></script>
<script type="text/javascript" src="dialog_page_common_web.js"></script>
<script type="text/javascript" src="../script/common-xunta.js"></script>
<script type="text/javascript" src="../script/common-xunta_web.js"></script>
<script type="text/javascript" src="../script/popup.js"></script>
<script type="text/javascript">
	var topicId = 'null';		//正常的TID，如果不是创建话题页，他没有被赋值 9.15 FANG
	var tmpTopicId = 'null';
	var userId;
	var title = "";
	var shortTitle = "";
	var userName;		//直接上屏用得着.
	var userImage;		//直接上屏时用得着.


	var requestMsgCounts = 10;
	var firstMsgId = '-1';
	var sort;

	var adminName;
	var adminImageurl;
	var userAgent;

	var replyTopic = 'null';//用来在发言时判断是否要发送给指定的用户， 如果是的话则有指定用户的话题ID，如果不是的话为null FANG 10.12
	var domain;
	//^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^从列表页进入对话框所带来的参数 9.14 fang
	var original_topicid = 'null';//本用户前一个跳出话题的id. 在新窗请求时会用到它.
	var from_topicid;
	var from_senderId;
	var from_senderName;
	var from_senderImg;
	var from_senderContent;
	//^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^在聊天框点击聊天内容进入对话框带来的参数 9.14 fang
	var firstMessage = true;
	var tmpTitle;
	var topicCreatedSuccess = false;
	var lastPostTimeLongMinute = 0;
	
	var replySenderName = "";
	var replySenderNameWithTopic = "";
	var replyOppuid =  "";
	var replyOpptid = "";
	/*
	 apiready = function() {//alert('1');

	 preparePageVars_movetonewtopicpage();			//初始化页面参数   9.14 FANG 增加
	 prepareDialogPage();
	 $("#moretodoicon").hide();
	 document.getElementById("inputbox").focus();//这是为了防止web版中别的页面打开后使这里得不到焦点.
	 }*/

	function start(Parameter) {//web:在openWin时通过ready后回调,再跨页执行方式来启动的第一个方法.
		console.log("执行dialog_page_movetonewtopic页面的start方法");
		preparePageVars_movetonewtopicpage(Parameter);			//初始化页面参数   9.14 FANG 增加
		execRoot("setCurrentPageId('" + tmpTopicId + "')");

		//暂时取消,换成下面两句:prepareDialogPage();
		adjustWidthsHeights(false);//参数应为isqingting,这个页面它一定是false.
		showTitle();

		if(topicId == 'none'){
			$("#moretodobox").hide();
		}
		$("#moretodoicon").hide();
		document.getElementById("inputbox").focus();//这是为了防止web版中别的页面打开后使这里得不到焦点.
	}

	function preparePageVars_movetonewtopicpage(Parameter){
		domain = Parameter.server_domain;
		howOpen = Parameter.howopen;
		topicId = Parameter.topicid;
		tmpTopicId = Parameter.tmptopicid;
		userId = Parameter.userid;
		title = Parameter.title;
		userName = Parameter.userName;
		userImage = Parameter.userImage;
		//用于直接上屏.
		//console.log("preparePageVars userImage="+userImage);
		original_topicid = Parameter.current_topic_id;
		//在上一页是current_,到了这一页是original_. xu
		//以下为新窗时带过来的参数. 如果不存在,则值=undefined.并依此判断是否为新窗.
		from_topicid = Parameter.from_topicid;
		from_senderId = Parameter.from_senderId;
		from_senderName = specialLettersDecoding(Parameter.from_senderName);
		from_senderImg = Parameter.from_senderImg;
		from_senderContent = specialLettersDecoding(Parameter.from_senderContent);
		//from_userId = json.from_userId; //这个应该没用了. xu9.17
		from_topictitle = Parameter.from_topictitle;

		adminName = Parameter.adminName;
		adminImageurl = Parameter.adminImageurl;
		userAgent = Parameter.userAgent;

		//多用户新窗  --zhangyy
		if(from_senderName.indexOf("-join-")!=-1) {
			var _objSize = from_senderName.split("-join-");
			$("#messagelist").html("");
			for(var i=0;i<_objSize.length;i++){
				var result = [];
				var _userid = userId.split("-join-")[i];
				result.push('<div class="from_user user other"><div class="nc">'+_objSize[i]+'</div>');
				result.push('<div class="detail" id="'+_userid+'">'+from_senderContent.split("-join-")[i]);
				result.push("</div>");
				result.push('<div class="user-pic"><img src="'+from_senderImg.split("-join-")[i]+'"/></div></div>');
				$("#messagelist").append(result.join(''));

				//  2017/01/22  注  取消刷新按钮  deng
//				var _con = $("#"+_userid);
//				var _h = Math.abs(parseInt(_con.height(),10)-19)/2;
//				var _w = parseInt(_con.width(),10)+68;
//				_con.after("<div class='refresh' style='margin: -"+_h+"px 0 0 "+_w+"px;' onclick='refreshClick(\""+userId.split("-join-")[i]+"\",\""+userName.split("-join-")[i]+"\",\""+userImage.split("-join-")[i]+"\")'>&nbsp;</div>");
			}
		}else{
			var _con = $(".from_user .detail");
			$(".from_user .nc").text(from_senderName);
			 _con.text(from_senderContent);

			//  2017/01/22  注  取消刷新按钮  deng
//			var _h = Math.abs(parseInt(_con.height(),10)-19)/2;
//			var _w = parseInt(_con.width(),10)+68;
//			 _con.after("<div class='refresh' style='margin: -"+_h+"px 0 0 "+_w+"px;' onclick='refreshClick(\""+userId+"\",\""+userName+"\",\""+userImage+"\")'>&nbsp;</div>");
			 $(".from_user img").attr("src",from_senderImg);
		}
	}

	//刷新加载更多数据信息
	function refreshClick(userId,userName,userImage){
		var pageParam = {
			"topicid" : topicId,
			"title" : tmpTitle,
			"userid" : userId,
			"userName" : userName,
			"userImage" : userImage,
			"server_domain" : domain,
			"isqingting" : 'false',
			"pageTitle":title,
			"adminName": adminName,
			"adminImageurl": adminImageurl,
			"userAgent":userAgent
		};
		console.log("enterDialogPage topicid=" + topicId+"|topictitle="+tmpTitle);
		openWin(topicId,'dialog_page/dialog_page.html',JSON.stringify(pageParam));

		execRoot("removeTmpTopicId('" + tmpTopicId + "')");//这句返回的不应该是tmptopicid,而是topicid. 因为这页不会再进来,所以没删掉,也不会出错?xu10.25
		execRoot("setCurrentPageId('topics_page')");//返回页面时要初始化话题列表页面的currentOpenDialogPageId变量,如果不初始化在回退到话题列表页时在没进入下一个聊天页面时，这时的消息如果发送到这里都会被认为已读，但实质上用户已经到了话题列表页 FANG 10.12
		exec("topics_page","removeUnreadNum('"+topicId+"')");//返回页面时要初始化话题列表页面的currentOpenDialogPageId变量,如果不初始化在回退到话题列表页时在没进入下一个聊天页面时，这时的消息如果发送到这里都会被认为已读，但实质上用户已经到了话题列表页 FANG 10.12
		closeWin(tmpTopicId);
	}

	function stopLoadingIcon_getPostHist(isSuccess) {

		//停止动画图标.
		//console.log("历史消息,延时检查 停止loading图标 isSuccess:" + isSuccess);
		if (isSuccess) {//无事可做.
			console.log("历史消息,延时检查说成功了 对话页");
			$("#loading img").attr("src", "../image/threedotmoving.jpg");
		} else {
			console.log("历史消息,延时检查说没成功");
			$("#loadingtext").text("网络有点慢,等会儿点击这里再试试.");
			$("#loadingwrap").click(function(evt) {//填加再次请求的点击事件:
//					alert("点击了");
				$("#loading img").attr('src', '../image/threedotmoving.gif');//恢复动态图片.
				$("#loadingtext").text("再次请求中...");
				window.parent.initToLoadPostHist(userId,topicId,firstMsgId,requestMsgCounts,sort);

				$("#loadingwrap").unbind('click');//点击后马上取消这个事件绑定.
			});
		}
	}

	/**
	 *	聊天框页面返回功能   9.15 FANG
	 *  */
	function backButton() {
		//返回时清除数组中的该话题ID和临时话题ID//
		openWin('topics_page', 'topics_page/topics_page.html', '');//显示列表页
		execRoot("removeTmpTopicId('" + tmpTopicId + "')");//这句返回的不应该是tmptopicid,而是topicid. 因为这页不会再进来,所以没删掉,也不会出错?xu10.25
		execRoot("setCurrentPageId('topics_page')");//返回页面时要初始化话题列表页面的currentOpenDialogPageId变量,如果不初始化在回退到话题列表页时在没进入下一个聊天页面时，这时的消息如果发送到这里都会被认为已读，但实质上用户已经到了话题列表页 FANG 10.12
		exec("topics_page","removeUnreadNum('"+topicId+"')");//返回页面时要初始化话题列表页面的currentOpenDialogPageId变量,如果不初始化在回退到话题列表页时在没进入下一个聊天页面时，这时的消息如果发送到这里都会被认为已读，但实质上用户已经到了话题列表页 FANG 10.12
		closeWin(tmpTopicId);
	}

	function inputSubmit() {//初步处理提交的发言.
		var inputValue = verifyInputText();//如果输入内容不合法,将返回"invalidvalue".
		if (inputValue == "invalidvalue") return;

		//在话题没有创建成功时发出的消息是失败的，提示用户暂时不能发言 9.15 FANG
		if (!firstMessage && !topicCreatedSuccess) {
			comtomToast('报歉,第一句发言提交成功后才能接着发言.请点击第一句发言再试一下.',2000,'middle');
			return;
		}
		afterInput4MoveToNewTopicPage(inputValue, "none");	//第二个参数为tmpPid.从输入框提交时为none.
	}

	function afterInput4MoveToNewTopicPage(inputValue, tmpPid) {//输入框提交到inputSubmit,然后到这里(此时tmpPid="none");感叹号直接提交都到这里(此时tmpPid!=none).

		if (topicCreatedSuccess == true) {	//到了这里就是正常发言了.
			afterInput(inputValue, tmpPid);//这个afterInput()是几个聊天页的共用方法,以后移到dialog_page_common里.
		}else{
			if (tmpPid == 'none') {//如果tmpPid为none,则表示从输入框提交.如果不是none,则是发送失败后,点击感叹号再次提交的.
				var tmpPid = new Date().getTime();	//生成临时发言id.
				tmpTitle = inputValue;
				//shortTitle = inputValue;//在第一句发言时,发言内容就是标题.
				shortTitle = cutStringIfTooLong(inputValue,10);
				firstMessage = false;
				showSelfPoster(inputValue, topicId, tmpPid);//消息直接上屏，并添加跳豆.
				console.log("新窗时首先从输入框的提交发言,tmpTitle和shortTitle都等于'发言'内容.");
			}else{//如果是从感叹号提交的, 可能要处理一下特殊字符
				console.log("初次失败后从感叹号再次提交发言,inputValue="+inputValue);
			}
			inputValue = specialLettersCoding(inputValue);//换成xunta专用代表字符串.

			if(from_topicid.indexOf("-join-")!=-1){
				execRoot("batch_initMoveToNewTopic('" + tmpPid + "','" + inputValue + "','" + original_topicid + "','" + tmpTopicId + "'," + "'" + from_topicid + "','" + userId + "')");
			}else{
				execRoot("initMoveToNewTopic('" + tmpPid + "','" + inputValue + "','" + original_topicid + "','" + tmpTopicId + "'," + "'" + from_topicid + "','" + from_senderId + "','" + userId + "')");
			}

			console.log('新窗创建未成功状态,移动创建话题的第一句话准备发往服务器:' + inputValue);
		}
	}


	function afterCheckedMoveToNewTopicSuccess(tmpPid, SendPosterSuccess) {//一般发言,新创话题,移动新建的延时检查处理都用这个方法.
		if (SendPosterSuccess) {
			alert(SendPosterSuccess);
			console.log("afterCheckedSendPosterSuccess 成功了,不作为");
		} else {//取消跳豆,加上感叹号,并绑定点击再请求的事件:
			console.log("afterCheckedSendPosterSuccess 失败, 取消跳豆,加上感叹号.");
			var thePosterElement = $("#dialog_box").find("#" + tmpPid);
			thePosterElement.find(".postsending").attr('src', "../image/acclaim-50x173.png");
			thePosterElement.click(function() {
				var thePosterElementObj = $("#dialog_box").find("#" + tmpPid);
				thePosterElementObj.find(".postsending").attr('src', '../image/jumpingbean.gif');
				afterInput4MoveToNewTopicPage(thePosterElement.find(".detail").text(), tmpPid);
				//发言再次发送后, 后台要判断一下tmpPid是否已经发过了,如果有,,则返回原来的topicid和内容.否则会重复.
				thePosterElement.unbind('click');
			});
		}
	}





	//=====================================以上为web代码，以下为web/app共用代码=================================================================================================================================================================================================================================


	function click2RequestMyTopicList_4moveto(){//首次调用准备.
		$("#e-lib .mytopiclist").attr("page","1");
		request_mytopiclist_4moveto(1);
		//alert("发出move2existedtopic请求...");
	}

	function request_mytopiclist_4moveto(page){//用于重复的"更多"调用
		//var currentTopicId = topicId;
		//if (topicId == "none"){currentTopicId = tmpTopicId} //针对在新窗页中未成功创建时点击直接接入按钮.
		console.log("request_mytopiclist_4moveto()-"+topicId+"|"+tmpTopicId);
		var _tid = from_topicid;
		if(_tid.indexOf("-join-")>0){
			_tid = _tid.split("-join-")[0];
		}
		var script = "request_mytopiclist_4moveto('"+page+"','"+_tid+"','"+tmpTopicId+"')";
		execRoot(script);
	}

	function request_move2existedtopic(mytopictitle_movedto,mytopicid_moveto){
		api.confirm({
			buttons : ['确定', '取消'],
			msg : "将Ta的话题直接接入["+mytopictitle_movedto+"]?"
		}, function(ret, err) {
			if (ret.buttonIndex == 1) {
				var script = "requestMove2ExistedTopic('"+tmpTopicId+"','"+original_topicid+"','"+from_topicid+ "','" + mytopicid_moveto+"')";
				execRoot(script);
			}
		});
	}


	//创建话题请求成功的状态标记   9.15 FANG //movetonewtopic成功后,也用这个方法标记成功.
	function markMoveToNewTopicSuccess(eventdata) {// FANG 直接把服务器返回的json对象传进来了，否则还要一个个的获取参数，比较麻烦 9.21
		$("#loading img").attr("src", "../image/threedotmoving.jpg");
		$("#loadingtext").text("新话题成功创建,可以在这里和Ta对话了.");
		$("#move2existedtopic").remove();
		$("#moretodoicon").show();
		console.log("markMoveToNewTopicSuccess msg=");

		topicCreatedSuccess = true;
		topicId = eventdata.topicid;
		title = tmpTitle;
		shortTitle = cutStringIfTooLong(title,10);//标题长度如果大于7就要省略掉后面的////在显示聊天历史中也有这个判断.
		showTitle(title);

		//------------------------------------房  9.21
		/**
		 *	获取服务器返回来的json消息，编辑上屏消息
		 * 	1、将服务器返回来的消息ID替换掉聊天框里的消息临时ID
		 * 	2、取消黑色跳豆的状态，因为话题已创建成功
		 * 	3、添加服务器返回来的时间
		 *  */
		var pid = eventdata.pid;			//获取服务器返回来的正式消息ID。
		var tmpPid = eventdata.tmp_pid;		//获取服务器返回来的临时消息ID
		var postTimeStr = eventdata.poster_create_datetime_str;
		var postTimeLong = eventdata.poster_create_datetime_long / 1000 / 60;//将时间转换成 月日 时分
		markSendPosterSuccess(tmpPid,pid,postTimeLong,postTimeStr);

		var time = eventdata.poster_create_datetime_str.substring(5, 16);
		//话题创建成功后，将话题显示在话题列表页上
		var script = "appendElement('" + title + "','" + topicId + "','new','" + time + "','post_topic','" + userName + "','" + tmpTitle + "','0')";
		exec("topics_page", script);

		$(".refresh").show();
	}


</script>
</html>