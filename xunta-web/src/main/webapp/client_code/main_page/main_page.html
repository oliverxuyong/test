<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="apple-mobile-web-app-capable" content="yes"/>
		<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
		<title>话题列表页</title>
		<link rel="stylesheet" type="text/css" href="topics_page.css"/>
		<link rel="stylesheet" type="text/css" href="topics_page_web.css"/>
		<link rel="stylesheet" type="text/css" href="../css/common_web.css"/>
		<link rel="stylesheet" type="text/css" href="alter_userimage.css"/>
		<link rel="stylesheet" type="text/css" href="../css/popup.css"/>
        <link rel="stylesheet" type="text/css" href="../css/popcontext.css"/>

		<!--让输入框的提示字颜色变淡-->
		<style>
		::-webkit-input-placeholder { /* WebKit, Blink, Edge */	opacity:  0.2;	}
		:-moz-placeholder { /* Mozilla Firefox 4 to 18 */	opacity:  0.2;	}
		::-moz-placeholder { /* Mozilla Firefox 19+ */	opacity:  0.2;	}
		:-ms-input-placeholder { /* Internet Explorer 10-11 */	opacity:  0.2;	}
		</style>

	</head>
<body>
	<!--<img id="imageundertopiclist" src="image/windblowgrass-2.gif"/>-->

	<div id="showatloaded" class="showatloaded">

		<div id="top-container" class="top-container">
			<div class="header-container">
				<!--头像-->
				<div class="userimg">
					<img id="topic_img" src="" onclick="openHomePage()" />
				</div>
				
				<!-- 名字 -->
				<div class="webname">
				wolf
				</div>
				<!-- 信号 -->
				<div id="showonlineoffline">
					<img src="../image/signal-gray.png" onclick="wsConnect()">
				</div>
				<!-- 重新登录-->
				<div id="showouseroprate">
					<img src="../image/exit.png" onclick="logOff()">
				</div>
			</div>
			
			<!-- 我的标签 -->
			<div class="mytag-container" id="mytag-container">
				<div class="addtagimg" id="addtagimg" onclick="addTag()"><img src="../image/add_tag.png"></div>
				<!--  <div class="mytag"><img src="../image/acclaim-50x173.png"><span>90后</span></div>-->
			</div>
		</div>
		
		<!--2017.07.19  叶夷  聊天按钮
		<button type="button" onclick="enterDialogPage()" style="width:100%;position:absolute;top:150px">聊天</button> -->
		
		<!--2017.07.26  叶夷  聊天列表
		<button type="button" onclick="EnterdialogList()" style="width:100%;position:absolute;top:175px">聊天列表页</button> -->
		
		<!--2017.07.27  叶夷  添加标签按钮
		<button type="button" onclick="addTag()" style="width:100%;position:absolute;top:200px">添加标签按钮</button>-->
		
		<!--2017.08.07  叶夷  匹配人列表
		<button type="button" onclick="enterMatchUsersPage()" style="width:100%;position:absolute;top:125px">匹配人列表</button> --> 
		
		<div class="tag-container">
		
			<!-- 装"推荐标签"四个字的容器 -->
			<div class="othertagtext">推荐标签</div>
		
			<!-- CP容器的HTLM标范,不要删,用于css调试 -->
			<div id="cp-show" class="othertag">
				<div id="cp-container" style="/*  position:fixed; */ width:100%;">
				<!-- <div class="cp" id="cpid1" class="selected">CP111111111	</div>-->
				<!-- <div class="cp" id="cpid2" class="unselected">CP2222222222			</div>-->
				<!-- <div class="cp" id="cpid3" class="unselected">CP3333333			</div>-->
				</div> <!-- END of CP容器的HTLM标范,不要删,用于css调试 -->
		
				<div style="width:100%;height:23%;"></div>
				<!-- start: 叶夷  2017.06.15  添加一个按钮，点击后通过已定义的接口向后台请求一组标签，后台返回后将标签显示出来。点击后继续请求下一页。-->
				<div class="getmoretopics cursor" id="request_cp" onclick="requestCP(userId,requestCPNum,(requestCPNum*(currentRequestedCPPage++)))">
					<div>
						+
					</div>
					<div>
						更多标签
					</div>
				</div>
				
				<!--<button id="request_cp" type="button" onclick="requestCP(userId,requestCPNum,(requestCPNum*(currentRequestedCPPage++)))" style="width:100%;display:none;">请求标签</button>
				 end: 叶夷  -->
			</div>
		
			<!-- 装"为你匹配的人"文字的容器 -->
			<div class="match_userstext" >为你匹配的人</div>
		
			<!--2017.07.04  叶夷   匹配人列表 -->
			<div class="matchUserList">
				<div class="match_users" id="match_users">
			
				</div>
				<div class="enterMatchUserList" onclick="enterMatchUsersPage()"><img src="../image/u423.png"></div>
			</div>
		</div>
		
		<!-- "聊天"文字容器 -->
		<div class="enterdialogList" id="enterdialogList" onclick="EnterdialogList()">
			聊天
		</div>
		
	</div> <!--End of <div id="showatloaded" class="showatloaded"> -->
	
</body>
<script type="text/javascript" src="../script/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="../script/common-xunta.js"></script>
	<script type="text/javascript" src="../script/common-xunta_web.js"></script>
	<script type="text/javascript" src="../script/popup.js"></script>
	<script type="text/javascript" src="topics_page.js"></script>
	<script type="text/javascript" src="topics_page_web.js"></script>
	<script type="text/javascript" src="../script/popup.js"></script>
	<script type="text/javascript" src="../script/popcontext.js"></script>
	<script type="text/javascript" src="http://xunta.so:3000/javascripts/websocket.io.js"></script>
	
	
	<script type="text/javascript">
		var userId;
		//var unionid;//第三方原生ID
		var userName;
		var userImgUrl;
		
		var pageTitle;
		var adminName;
		var adminImageUrl;
		
		var projectType;
		var domain;
		var userAgent;
		var requestCPNum = 20; //每次请求话题数
		var requestTopMUNum=10;//每次请求用户匹配排名数量
		var currentRequestedCPPage = 0; //page指第几次请求到的返回结果集.0表示还没有请求到.请求成功后,要加1. 
		var unreadObjList=new Array();//2017.08.16 为了装所有的未读信息，然后将数组传给聊天列表

		function start(pageParamsStr) {//web:在openWin时通过ready后回调,再跨页执行方式来启动的第一个方法.
			//1。11 新增，   显示Log日志后点击return事件返回到话题列表页时是没有参数的，data为''，所以下面加个判断条件，为''就结束该方法  FANG
			retrievePageParams(pageParamsStr); 
			prepareTopicsPage();
			setRootVars();
			//showCP();
			//wsConnect();
			
			//叶夷 2017.06.15  我觉得这里应该是++才能体现出这个次数的效果
			//requestCP(userId,requestCPNum,currentRequestedCPPage+1);
			requestCP(userId,requestCPNum,++currentRequestedCPPage);
			
			//2017.07.04  叶夷  
			addMPData();//匹配人列表测试
			//requestTopMatchedUsers(userId,requestTopMUNum);//请求用户匹配缩略表,不能放在这里，因为不能同时请求,等请求cp返回且显示之后再请求这个方法，所以此方法放在responseToCPRequest(CP_list)中
			
			//2017.08.09  叶夷  显示我的标签
			requestMyCP();
			
			/* //2017.08.15 显示未读消息
			showUnreadNum(); */
			
			chat.init(userId,recevier);//注册用户，及用记接收消息的函数
		}
		
		//发送消息之后服务器返回的消息
        function recevier(obj) {
        		respondeUserId=JSON.stringify(obj.user.userId);
        		user = JSON.stringify(obj.user.name);
        		data = JSON.stringify(obj.data);
        		imgUrl=JSON.stringify(obj.user.imgUrl);
        		//去掉引号
        		respondeUserId= respondeUserId.replace(/\"/g, "");
        		data = data.replace(/\"/g, "");
        		user = user.replace(/\"/g, "");
        		imgUrl=imgUrl.replace(/\"/g, "");
        		
        		var respondeToUserId;
        		if(userId=="804622010041896960"){
        			respondeToUserId="745600342770716672";
        		}else{
        			respondeToUserId="804622010041896960";
        		}
        	
        		var msgId = new Date().getTime();				//生成临时发言id.
        		var myOrOther;
        		if (userId === respondeUserId) {
        			myOrOther="my";
        			/* var postTimeStr=new Date();
        			var postTimeLong = postTimeStr.getTime();
        			postTimeStr=postTimeStr.Format("yyyy-MM-dd hh:mm:ss");
        			markSendPosterSuccess(msgId,postTimeLong,postTimeStr); */
        			//exec(pageName, script);
        			//var taskid_sendposter =  toUserId + "-" + msgId;
        			//返回的消息是个数组,但目前只会有一个.
        			//doSendPoster[taskid_sendposter] = "none";
        			//取消任务筐里的任务.
        			//showSelfPoster(user, data,imgUrl,msgId,"my",false);
            	} else {
            		myOrOther="other";
            		//showSelfPoster(user, data,imgUrl,msgId,"other",false);
            		
            		//聊天列表未读消息提示
            		if(window.parent.document.getElementById("dialoglist_page")!=null ){//聊天列表打开过
            			exec("dialoglist_page", "unreadMsg('"+respondeUserId+"','"+1+"')");
            		} 
            		
            		//首页未读消息提示
            		//exec("main_page", "unreadMsg()");
            		unreadMsg();
            		//提示音
            		//notifyNewMessage(pageTitle);
            		execRoot("notifyNewMessage('"+pageTitle+"')");
            		
            		//2017.08.16   装所有的未读信息，为了将数组传给聊天列表
            		var unreadNum=1;
            		if(unreadObjList.length!=0){
            			var isExit=false;
            			for(var j in unreadObjList){
            				var unReadObj=unreadObjList[j];
            				if(unReadObj.getTouserId()==respondeToUserId){//这个用户已经存在，未读数加1
            					unreadNum++;
            					unreadObjList[j]=new unreadObj(respondeToUserId,unreadNum);
            					isExit=true;
            					break;
            				}
            			}
            			if(isExit=false){
            				unreadObjList.push(new unreadObj(respondeToUserId,unreadNum));
            			}
            		}else{
            			unreadObjList.push(new unreadObj(respondeToUserId,unreadNum));
            		}
            		
            	}
        		//showSelfPoster(user,data,imgUrl, msgId,myOrOther, false);
        		if(window.parent.document.getElementById(respondeToUserId)!=null ){//聊天列表打开过
        			exec(respondeToUserId, "showSelfPoster('" + user + "','" + data +"','" +imgUrl+"','" + msgId+"','" + myOrOther+ "','" + false+"')");
        			//加上时间 
        			var postTimeStr=JSON.stringify(obj.timestr).replace(/\"/g,"");
            		var postTimeLong = new Date((postTimeStr).replace(new RegExp("-","gm"),"/")).getTime();
            		exec(respondeToUserId, "markSendPosterSuccess('" + msgId + "','" + postTimeLong +"','" +postTimeStr+"')");
            		//markSendPosterSuccess(msgId, postTimeLong ,postTimeStr);
        		} 
        };
        
        function sendmsg(toUserId,inputValue){
        	chat.sendPrivateMsg(toUserId,inputValue);
        }
		
		function setRootVars(){
			execRoot("setTopicsPageOpenMark()");//可能还有其它表示列表页打开的标志.
			execRoot("setCurrentPageId('main_page')");  
		}
		
		function prepareTopicsPage(){
			/*这个地方要修改:允许微信和QQ登录下也可以修改头像.//?
			if(userinfoObj.type!='mobilephone'){//只有手机登录时用户才能修改头像
				$("#alterUserimage").hide();
			}else{
				$("#alterUserimage").show();
			}*/
			$(".userimg>img").attr("src", userImg);
			//$("#username").text(userName);
			
			//if ( projectType == "WEB" ){
			//	if ( userAgent[0] == "PC" ){
			//		$("#userimage").css("right","32px");//向左让出右侧的滚动条.
			//	}
			//}
			
			//web上不需任何侦听. addListeners(); //这个方法是空的,是为了让topics_page页面与app保持一致.
			
			
			setTimeout(function() {
				//开始就显示桔黄色信息是不对的. 应该在ws成功连接后再显示.$("#showonlineoffline>img").attr("src","../image/signal-orange.png");
				//$("body").prepend("<img id='imageundertopiclist' src='../image/imageundertopiclist.jpg'/>");
				$("#imageundertopiclist").fadeIn(1500);//延迟并缓慢显示背景图片.
			}, 1000);
			
			
			
			
		}

		function retrievePageParams(pageParamsStr){
			if (pageParamsStr == '') {
				toast("打开列表页时发现传递的参数为空.请与开发者联系.");
				return;
			}
			//console.log(pageParamsStr);
			//topicList = JSON.parse(pageParamsStr.topiclist);//注意不能直接parse(pageParamsStr),原因不明.必须parse下面一级的键值对.
			//topicList = pageParamsStr.topiclist;
			//注意不能直接parse(pageParamsStr),原因不明.必须parse下面一级的键值对.
			//var publicVars = JSON.parse(pageParamsStr.publicVars);
			var publicVars = pageParamsStr.publicVars;
			domain = publicVars.domain;
			projectType = publicVars.projectType;
			userAgent = publicVars.userAgent;
			//console.log(userAgent);	console.log(userAgent[0]);	console.log(userAgent[1]);
			pageTitle = publicVars.pageTitle;
		    adminName = publicVars.adminName;
		    adminImageurl = publicVars.adminImageurl;
		    console.log("adminName:"+adminName);
			var userinfoObj = publicVars.userInfo;
			userId = userinfoObj.uid;
			userName = userinfoObj.name;
			userImg = userinfoObj.image;
			//unionid = userinfoObj.unionid;
			//topicList = Parameter.topiclist;
		}
		
		//2017.08.16 叶夷   创建跟我聊天的人的id和未读消息数一一对应的对象，为了保存数组
		function unreadObj(touserId,unreadNum){
			var obj = new Object();
			obj.touserId=touserId;
			obj.unreadNum=unreadNum;
			obj.getTouserId = function() {
				return this.touserId;
			};
			obj.getUnreadNum = function() {
				return this.unreadNum;
			};
			return obj;
		}
		
	</script>
</html>