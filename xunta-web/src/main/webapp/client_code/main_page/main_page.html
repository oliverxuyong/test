<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="apple-mobile-web-app-capable" content="yes"/>
		<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
		<title>话题列表页</title>
		<link rel="stylesheet" type="text/css" href="topics_page.css"/>
		<link rel="stylesheet" type="text/css" href="topics_page_web.css"/>
		<link rel="stylesheet" type="text/css" href="../css/common_web.css"/>
		<link rel="stylesheet" type="text/css" href="alter_userimage.css"/>
		<link rel="stylesheet" type="text/css" href="../css/popup.css"/>
        <link rel="stylesheet" type="text/css" href="../css/popcontext.css"/>

		<!--让输入框的提示字颜色变淡-->
		<style>
		::-webkit-input-placeholder { /* WebKit, Blink, Edge */	opacity:  0.2;	}
		:-moz-placeholder { /* Mozilla Firefox 4 to 18 */	opacity:  0.2;	}
		::-moz-placeholder { /* Mozilla Firefox 19+ */	opacity:  0.2;	}
		:-ms-input-placeholder { /* Internet Explorer 10-11 */	opacity:  0.2;	}
		</style>

	</head>
<body>
	<!--<img id="imageundertopiclist" src="image/windblowgrass-2.gif"/>-->

	<div id="showatloaded" class="showatloaded">
		
		<div id="top-container" class="top-container">
			<div class="header-container" id="header-container">

				<!-- 重新登录-->
				<!-- div id="showouseroprate">
					<img src="../image/exit.png" onclick="logOff()">
				</div-->
				
				<!--头像-->
				<div id="userinfo">
					<div id="userimg">
						<!-- 信号 -->
						<div id="showonlineoffline">
							<img src="../image/dot-gray.png" onclick="wsConnect()" />
						</div>
						<img onclick="ask2LogOff()" onerror="javascript:this.src='http://42.121.136.225:8888/user-pic2.jpg'"/>
						<div id="username"></div>
					
					</div>
					
				</div>
				
				<!--2017.07.04  叶夷   匹配人列表 -->
				<!-- <div class="mu" id="mutemp1" style="/* left: 145px; */width: 48px;height: 48px;/* top: 80px; */"></div>
    			<div class="mu" id="mutemp2" style="/* left: 193px; */width: 45px;height: 45px;/* top: 83px; */"></div>
    			<div class="mu" id="mutemp3" style="/* left: 240px; */width: 42px;height: 42px;/* top: 85px; */"></div>
    			<div class="mu" id="mutemp4" style="/* left: 281px; */width: 39px;height: 39px;/* top: 84px; */"></div>
    			<div class="mu" id="mutemp5" style="/* left: 318px; */width: 36px;height: 36px;/* top: 79px; */"></div>
    			<div class="mu" id="mutemp6" style="/* left: 342px; */width: 33px;height: 33px;/* top: 57px; */"></div>
    			<div class="mu" id="mutemp7" style="/* left: 346px; */width: 30px;height: 30px;/* top: 31px; */"></div>
    			<div class="mu" id="mutemp8" style="/* left: 332px; */width: 27px;height: 27px;/* top: 13px; */"></div>
    			<div class="mu" id="mutemp9" style="/* left: 313px; */width: 24px;height: 24px;/* top: 5px; */"></div>
    			<div class="mu" id="mutemp10" style="/* left: 296px; */width: 23px;height: 23px;/* top: 2px; */"></div>
    			<div class="mu" id="mutemp11" style="/* left: 342px; */width: 22px;height: 22px;/* top: 57px; */"></div>
    			<div class="mu" id="mutemp12" style="/* left: 346px; */width: 21px;height: 21px;/* top: 31px; */"></div>
    			<div class="mu" id="mutemp13" style="/* left: 332px; */width: 20px;height: 20px;/* top: 13px; */"></div>
    			<div class="mu" id="mutemp14" style="/* left: 313px; */width: 19px;height: 19px;/* top: 5px; */"></div>
    			<div class="mu" id="mutemp15" style="/* left: 296px; */width: 18px;height: 18px;/* top: 2px; */"></div>
    			 -->
    			
			</div>

			<!-- 我的标签 -->
			<div class="mytag-container" id="mytag-container">
			<img id="background-rightbar-mytag" src="../image/background1-rightbar.jpg"><!--用来覆盖右边的滚动条 -->
				<div  class="mytag" id="addtag" onclick='addTag()'>
					<!-- img src="../image/plus3.jpg"-->
				</div>
				<!-- <div class="mytag"><img src="../image/acclaim-50x173.png"><span>阿斯蒂芬8后</span></div> -->
				<!-- <div class="mytag" id="addtag2" onclick="addTag()" style="width:86px;"> 万有引力 					
					<div class="mytag-selectednumber">123</div>
				</div> -->
				
			</div>

			
		</div>
		
		<div class="tag-container" id="tag-container">
		<img id="background-rightbar" src="../image/background1-rightbar.jpg"><!--用来覆盖右边的滚动条 -->
			<!-- CP容器的HTLM标范,不要删,用于css调试 -->
			<div id="cp-show" class="othertag">
				<div id="cp-container" style="/*  position:fixed; */ width:100%;">
				
				<!--div class="cp" id="cpid1" class="selected">CP111111111<div class="cp-selectednumber">988</div></div-->
				
				<!-- <div class="incp" style="position:fixed; top: 800px; left: 100px; height: 73px; width: 73px;">
					<div class="cp-selectednumber">168</div>
					<div style="color:white;line-height: 38px; height: 42px; width: 52.5px; font-size: 15px; top: 15.5px; left: 10.25px;">
					一半
					</div>
					
					
				</div> -->
				
				
				
				
				<!-- <div class="cp" id="cpid2" class="unselected">CP2222222222			</div>-->
				<!-- <div class="cp" id="cpid3" class="unselected">CP3333333			</div>-->
				</div> <!-- END of CP容器的HTLM标范,不要删,用于css调试 -->
		
				<div style="width:100%;height:23%;"></div>
				<!-- start: 叶夷  2017.06.15  添加一个按钮，点击后通过已定义的接口向后台请求一组标签，后台返回后将标签显示出来。点击后继续请求下一页。-->
				<div class="getmoretopics cursor" id="request_cp" onclick="requestCP(userId,requestCPNum,(requestCPNum*(currentRequestedCPPage++)))">
					<div>更多</div>
				</div>
				
				<!--<button id="request_cp" type="button" onclick="requestCP(userId,requestCPNum,(requestCPNum*(currentRequestedCPPage++)))" style="width:100%;display:none;">请求标签</button>
				 end: 叶夷  -->
			</div>
			
		</div>
		
		<!-- "进入聊天列表按钮"用fixed后,不论放在哪里,都只看屏幕的长宽.-->
		<div class="enterdialogList" id="enterdialogList" onclick="EnterdialogList()">
			<img src="../image/new-msg-3.png" />
		</div>

		<!-- 选中标签并发websocket测试按钮 -->
		<!-- <div onclick="requestUserIds()" style="position: absolute;top: 26px;left: 100px;background: #f1f1f1;z-index:999;">
			并发测试按钮 
		</div> -->
		<!-- 选中标签性能测试停止按钮
		<div onclick="cleartimeout()" style="position: absolute;top: 52px;left: 100px;background: #f1f1f1;">
			选中标签测试停止
		</div>-->
		
	</div> <!--End of <div id="showatloaded" class="showatloaded"> -->
	
</body>
<script type="text/javascript" src="../script/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="../script/common-xunta.js"></script>
	<script type="text/javascript" src="../script/common-xunta_web.js"></script>
	<script type="text/javascript" src="../script/popup.js"></script>
	<script type="text/javascript" src="topics_page.js"></script>
	<script type="text/javascript" src="topics_page_web.js"></script>
	<script type="text/javascript" src="../script/popup.js"></script>
	<script type="text/javascript" src="../script/popcontext.js"></script>
	<script type="text/javascript" src="http://xunta.so:3000/javascripts/websocket.io.js"></script>
	<!-- 这是为了移动端web的调试 
	<script src="../script/debuggap.js" type="text/javascript"></script>-->
	
	
	<script type="text/javascript">
		var userId;
		//var unionid;//第三方原生ID
		var userName;
		var userImgUrl;
		
		var pageTitle;
		var adminName;
		var adminImageUrl;
		
		var projectType;
		var domain;
		var userAgent;
		var requestCPNum = 20; //每次请求话题数
		var requestTopMUNum=20;//每次请求用户匹配排名数量
		var currentRequestedCPPage = 0; //page指第几次请求到的返回结果集.0表示还没有请求到.请求成功后,要加1. 
		var unreadObjList=new Array();//2017.08.16 为了装所有的未读信息，然后将数组传给聊天列表
		var firstRequestTopMatchedUsers=true;//2017.09.04  叶夷      判断是否是第一次请求匹配列表

		function start(pageParamsStr) {//web:在openWin时通过ready后回调,再跨页执行方式来启动的第一个方法.
			//1。11 新增，   显示Log日志后点击return事件返回到话题列表页时是没有参数的，data为''，所以下面加个判断条件，为''就结束该方法  FANG
			retrievePageParams(pageParamsStr); 
			prepareTopicsPage();
			setRootVars();
			
			//叶夷 2017.06.15  我觉得这里应该是++才能体现出这个次数的效果
			//requestCP(userId,requestCPNum,currentRequestedCPPage+1);
			requestCP(userId,requestCPNum,++currentRequestedCPPage);
			
			//2017.08.23 叶夷   各个控件根据屏幕调整
			showMatchedUsers();
			
			//2017.07.04  叶夷  
			//addMPData();//匹配人列表测试
			//requestTopMatchedUsers(userId,requestTopMUNum);//请求用户匹配缩略表,不能放在这里，因为不能同时请求,等请求cp返回且显示之后再请求这个方法，所以此方法放在responseToCPRequest(CP_list)中
			
			//2017.08.09  叶夷  显示我的标签
			//requestMyCP();
			
			chat.init(userId,recevier);//注册用户，及用记接收消息的函数
			
			//console.log("测试："+window.screen.width+" "+window.screen.height);
		}
		
		//点击 我的头像,询问是否退出登录,如果是,则退出:
		function ask2LogOff(){
			//待叶夷完善:
			logOff();
			
		}
		
		
		//发送消息之后服务器返回的消息
        function recevier(obj) {
        		respondeUserId=JSON.stringify(obj.user.userId);
        		user = JSON.stringify(obj.user.name);
        		data = JSON.stringify(obj.data);
        		imgUrl=JSON.stringify(obj.user.imgUrl);
        		//去掉引号
        		respondeUserId= respondeUserId.replace(/\"/g, "");
        		data = data.replace(/\"/g, "");
        		user = user.replace(/\"/g, "");
        		imgUrl=imgUrl.replace(/\"/g, "");
        		
        		var postTimeStr=JSON.stringify(obj.timestr).replace(/\"/g,"");
        		var postTimeLong = new Date((postTimeStr).replace(new RegExp("-","gm"),"/")).getTime();
        		
        		var window_id;//和我聊天的人的id，用来定位聊天页面，后面字段名要变成window_id
        	
        		var msgId = new Date().getTime();				//生成临时发言id.
        		var myOrOther;
        		if (userId === respondeUserId) {
        			window_id=obj.window_id;
        			var msgId=obj.handler;
        			var str = "judgeSelfPosterReturnOrOthers('" + window_id + "','" + msgId + "','" + postTimeLong +"','" +postTimeStr +"')";
        		    execRoot(str);
        		    
        		    if(window.parent.document.getElementById("dialoglist_page")!=null ){//聊天列表打开过,实现置顶
        		    	exec("dialoglist_page", "updateDialogContentAndTime('','"+data+"','"+postTimeStr+"','"+window_id+"')");//更新聊天列表内容和时间
            			exec("dialoglist_page", "makeDialogListTop('" + window_id +"')");
            		}
            	} else { 
            		myOrOther="other";
            		window_id=respondeUserId;
            		//showSelfPoster(user, data,imgUrl,msgId,"other",false);
            		
            		//聊天列表未读消息提示
            		if(window.parent.document.getElementById("dialoglist_page")!=null ){//聊天列表打开过
            			exec("dialoglist_page", "unreadMsg('"+user+"','"+data+"','"+postTimeStr+"','"+respondeUserId+"','"+1+"')");
            		}else{//聊天页表没有打开才将未读信息保存好
            			//2017.08.16   装所有的未读信息，为了将数组传给聊天列表
                		var unreadNum=1;
                		if(unreadObjList.length!=0){
                			var isExit=false;
                			for(var j in unreadObjList){
                				var unReadObj=unreadObjList[j];
                				if(unReadObj.getTouserId()==respondeUserId){//这个用户已经存在，未读数加1
                					unreadNum++;
                					unreadObjList[j]=new unreadObj(user,data,postTimeStr,respondeUserId,unreadNum);
                					isExit=true;
                					break;
                				}
                			}
                			if(isExit=false){
                				unreadObjList.push(new unreadObj(user,data,postTimeStr,respondeUserId,unreadNum));
                			}
                		}else{
                			unreadObjList.push(new unreadObj(user,data,postTimeStr,respondeUserId,unreadNum));
                		}
            		}
            		
            		//首页未读消息提示
            		//exec("main_page", "unreadMsg()");
            		unreadMsg();
            		//提示音
            		//notifyNewMessage(pageTitle);
            		execRoot("notifyNewMessage('"+pageTitle+"')");
            		
            		if(window.parent.document.getElementById(window_id)!=null ){//聊天列表打开过
            			exec(window_id, "showSelfPoster('" + user + "','" + data +"','" +imgUrl+"','" + msgId+"','" + myOrOther+ "','" + false+"')");
            			//加上时间 
                		exec(window_id, "markSendPosterSuccess('" + msgId + "','" + postTimeLong +"','" +postTimeStr+"')");
            		} 
            		
            		//每次接收到消息消息列表置顶
            		if(window.parent.document.getElementById("dialoglist_page")!=null ){//聊天列表打开过
            			exec("dialoglist_page", "makeDialogListTop('" + respondeUserId+"')");
            		}
            	}
        };
        
        function sendmsg(toUserId,inputValue,handler){
        	chat.sendPrivateMsg(toUserId,inputValue,handler);
        }
		
		function setRootVars(){
			execRoot("setTopicsPageOpenMark()");//可能还有其它表示列表页打开的标志.
			execRoot("setCurrentPageId('main_page')");  
		}
		
		function prepareTopicsPage(){
			/*这个地方要修改:允许微信和QQ登录下也可以修改头像.//?
			if(userinfoObj.type!='mobilephone'){//只有手机登录时用户才能修改头像
				$("#alterUserimage").hide();
			}else{
				$("#alterUserimage").show();
			}*/
			$("#userimg").show();
			var userimg=$("#userimg>img");
			userimg.attr("src", userImg);
			//if ( projectType == "WEB" ){
			//	if ( userAgent[0] == "PC" ){
			//		$("#userimage").css("right","32px");//向左让出右侧的滚动条.
			//	}
			//}
			
			//web上不需任何侦听. addListeners(); //这个方法是空的,是为了让topics_page页面与app保持一致.
			setTimeout(function() {
				//开始就显示桔黄色信息是不对的. 应该在ws成功连接后再显示.$("#showonlineoffline>img").attr("src","../image/signal-orange.png");
				//$("body").prepend("<img id='imageundertopiclist' src='../image/imageundertopiclist.jpg'/>");
				$("#imageundertopiclist").fadeIn(1500);//延迟并缓慢显示背景图片.
			}, 1000);
			
			//2017.08.23 叶夷   我的头像和昵称框位置
			//var headerContainerHeight=$(".header-container").css("height");
			//var userImgHeight=$(".userimg").css("height");
			var userImgWidth=parseInt(userimg.css("width"));
			//var userImgMarginTop=parseInt(headerContainerHeight)-parseInt(userImgHeight);
			//$(".userimg").css("margin-top", userImgMarginTop+"px");
			//头像大小位置和用户昵称大小位置
			var headerContainerWidth=$(".header-container").width();
			//var userimgHeight=headerContainerWidth*0.129;
			//userimg.css("width",userimgHeight);//图片高宽一致
			//userimg.css("height",userimgHeight);//图片高宽一致
			
			//2017.10.25 叶夷   用户昵称如果超过3个字则加上...
			var userNameText=userName;
			userNameText = "用户呢称遥远看再看一看看两看三";
			var usernameLength=strLength(userNameText);
			var userNameTextSizeMax = userImgWidth/5;//头像下一排最多只能排6个字.两排最多12个字.
			var userNameTextSize = userImgWidth/8;
			var userNameTextSizeMin=11;//头像下一排最多只能排6个字.两排最多12个字.
			var maxTextNumber=0;
			if(usernameLength*(userNameTextSizeMax+1)<=userImgWidth){
				userNameTextSize = userNameTextSizeMax;
			}else if(usernameLength*(userNameTextSizeMin+1)<=userImgWidth){
				//userNameTextSize = userNameTextSizeMin;
				userNameTextSize = (userImgWidth-usernameLength*1)/usernameLength;
				/*maxTextNumber = userImgWidth/userNameTextSize;
				if(usernameLength>maxTextNumber){
					userNameText=userNameText.substring(0,maxTextNumber-1)+"…";
				}*/
			}else if(usernameLength*userNameTextSizeMin<userImgWidth*1.3){
				userNameTextSize = userNameTextSizeMin;
				maxTextNumber = userImgWidth/userNameTextSize;
				if(usernameLength>maxTextNumber){
					userNameText=userNameText.substring(0,maxTextNumber-1)+"…";
				}
			}else if(usernameLength*userNameTextSizeMin < userImgWidth*2){
				maxTextNumber = (userImgWidth*2-usernameLength*1)/userNameTextSize;
				if(usernameLength>maxTextNumber){
					userNameText=userNameText.substring(0,maxTextNumber-1)+"…";
				}
			}else if(usernameLength*userNameTextSizeMin >= userImgWidth*2){
				userNameTextSize = userNameTextSizeMin;
				//maxTextNumber = (userImgWidth*2-usernameLength*1)/userNameTextSize;
				maxTextNumber = userImgWidth*2/userNameTextSize;
				if(usernameLength>maxTextNumber){
					userNameText=userNameText.substring(0,maxTextNumber-1)+"…";
				}	
			}
			
			console.log("======userNameTextSize1======="+userNameTextSize);
			//不让让字体太小,也不能太大
			//if(userNameTextSize<=11){
				//userNameTextSize=11;
			//}
			/*
			maxTextNumber = userImgWidth*2/userNameTextSize;
						if(usernameLength>maxTextNumber){
				userNameText=userNameText.substring(0,maxTextNumber-3)+"…";
			} */
			
			//如果字体小于12的时候，将昵称截断
			/*	var substringLength=userimgHeight/userNameTextSize;
				userNameText=userNameText.substring(0,substringLength)+"...";
				userNameTextSize=16;
*/
			//2017.10.25  叶夷  将昵称的大小调整
			var userNameObj=$("#username");
			userNameObj.css("font-size",userNameTextSize+"px");
			//username.css("font-size","18px");
			console.log("======userNameTextSize======="+userNameTextSize);
			
			//usernameHeight=parseInt(userImgHeight)-parseInt(userimgHeight);
			//username.css("height",(userNameTextSize+10)+"px");//这里加6是高度比字体的大小大约多了6个像素
			//var usernameMaiginTop=(usernameHeight-6-userNameTextSize-6)/2;
			//username.css("margin-top",usernameMaiginTop+"px");
			userNameObj.text(userNameText);

			
			//2017.10.25  叶夷   调整信号圆位置
			var showOnLineOffLine=$("#showonlineoffline");
			showOnLineOffLine.show();
			//小绿点大小调整
			//var showOnLineOffLineImgWidth=userimg.width()*0.2438;
			//showOnLineOffLine.find("img").css("width",showOnLineOffLineImgWidth);
			//showOnLineOffLine.find("img").css("height",showOnLineOffLineImgWidth);
			//根据屏幕的宽度调整进入聊天列表按钮的大小
			//var showOnLineOffLineWidth=showOnLineOffLine.find("img").width();
			//var showOnLineOffLineTop=userImgMarginTop-showOnLineOffLineWidth*0.55;
			//var showOnLineOffLineLeft=parseInt($(".userimg").css("margin-left"))+userimgHeight-showOnLineOffLineWidth;
			//showOnLineOffLine.css("top",showOnLineOffLineTop+"px");
			//showOnLineOffLine.css("left",showOnLineOffLineLeft+"px");
			
			//.toastinline刚上线时,  这里会出一个 连接恢复 的提示. 刚上线时的这个提示可以取消.
			//可以 用 设为不显的 方法 来取消. 等头像出来后, 再设为 显示. 头像出来了, 肯定是连接上了
			$(".toastinline").show();
			//进入聊天列表按钮大小
			/*var enterdialogList=$("#enterdialogList");
			var enterdialogListWidth=headerContainerWidth*0.066;
			enterdialogList.find("img").css("width",enterdialogListWidth);
			enterdialogList.find("img").css("height",enterdialogListWidth);
			*/
		}

		function retrievePageParams(pageParamsStr){
			if (pageParamsStr == '') {
				toast("打开列表页时发现传递的参数为空.请与开发者联系.");
				return;
			}
			//console.log(pageParamsStr);
			//topicList = JSON.parse(pageParamsStr.topiclist);//注意不能直接parse(pageParamsStr),原因不明.必须parse下面一级的键值对.
			//topicList = pageParamsStr.topiclist;
			//注意不能直接parse(pageParamsStr),原因不明.必须parse下面一级的键值对.
			//var publicVars = JSON.parse(pageParamsStr.publicVars);
			var publicVars = pageParamsStr.publicVars;
			domain = publicVars.domain;
			projectType = publicVars.projectType;
			userAgent = publicVars.userAgent;
			//console.log(userAgent);	console.log(userAgent[0]);	console.log(userAgent[1]);
			pageTitle = publicVars.pageTitle;
		    adminName = publicVars.adminName;
		    adminImageurl = publicVars.adminImageurl;
		    console.log("adminName:"+adminName);
			var userinfoObj = publicVars.userInfo;
			userId = userinfoObj.uid;
			userName = userinfoObj.name;
			userImg = userinfoObj.image;
			//unionid = userinfoObj.unionid;
			//topicList = Parameter.topiclist;
		}
		
		//2017.08.16 叶夷   创建跟我聊天的人的id和未读消息数一一对应的对象，为了保存数组
		function unreadObj(user,data,postTimeStr,touserId,unreadNum){
			var obj = new Object();
			obj.user=user;
			obj.data=data;
			obj.postTimeStr=postTimeStr;
			obj.touserId=touserId;
			obj.unreadNum=unreadNum;
			obj.getUser = function() {
				return this.touserId;
			};
			obj.getData = function() {
				return this.touserId;
			};
			obj.getPostTimeStr = function() {
				return this.touserId;
			};
			obj.getTouserId = function() {
				return this.touserId;
			};
			obj.getUnreadNum = function() {
				return this.unreadNum;
			};
			return obj;
		}
		
	</script>
</html>