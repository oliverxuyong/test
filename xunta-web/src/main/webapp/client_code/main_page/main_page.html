<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="apple-mobile-web-app-capable" content="yes"/>
		<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
		<title>话题列表页</title>
		<!-- <link rel="stylesheet" type="text/css" href="topics_page.css"/>
		<link rel="stylesheet" type="text/css" href="topics_page_web.css"/>
		<link rel="stylesheet" type="text/css" href="../css/common_web.css"/>
		<link rel="stylesheet" type="text/css" href="alter_userimage.css"/>
		<link rel="stylesheet" type="text/css" href="../css/popup.css"/>
        <link rel="stylesheet" type="text/css" href="../css/popcontext.css"/> -->

		<!--让输入框的提示字颜色变淡-->
		<style>
		::-webkit-input-placeholder { /* WebKit, Blink, Edge */	opacity:  0.2;	}
		:-moz-placeholder { /* Mozilla Firefox 4 to 18 */	opacity:  0.2;	}
		::-moz-placeholder { /* Mozilla Firefox 19+ */	opacity:  0.2;	}
		:-ms-input-placeholder { /* Internet Explorer 10-11 */	opacity:  0.2;	}
		</style>

	</head>
<body>
	<!--<img id="imageundertopiclist" src="image/windblowgrass-2.gif"/>-->

	<div id="showatloaded" class="showatloaded">
		
		<div id="top-container" class="top-container">
			<div class="header-container" id="header-container">

				<!-- 重新登录-->
				<!-- div id="showouseroprate">
					<img src="../image/exit.png" onclick="logOff()">
				</div-->
				
				<!--头像-->
				<div id="userinfo">
					<div id="userimg">
						<!-- 信号 -->
						<div id="showonlineoffline" style="display:none;">
							<img src="../image/dot-gray.png" onclick="wsConnect()" />
						</div>
						<img onclick="updUserImg()" onerror="javascript:this.src='http://42.121.136.225:8888/user-pic2.jpg'"/>
						<div id="username" onclick="alterNickname()"></div>
					
					</div>
					
				</div>
				
				<!-- 2017.12.14  叶夷  装匹配人列表的容器-->
				<div id="matchUsers" class="matchUsers" onclick="enterMatchUsersPage()">
				</div>
				<!--2017.07.04  叶夷   匹配人列表 -->
				<!-- <div class="mu" id="mutemp1" style="/* left: 145px; */width: 48px;height: 48px;/* top: 80px; */"></div>
    			<div class="mu" id="mutemp2" style="/* left: 193px; */width: 45px;height: 45px;/* top: 83px; */"></div>
    			<div class="mu" id="mutemp3" style="/* left: 240px; */width: 42px;height: 42px;/* top: 85px; */"></div>
    			<div class="mu" id="mutemp4" style="/* left: 281px; */width: 39px;height: 39px;/* top: 84px; */"></div>
    			<div class="mu" id="mutemp5" style="/* left: 318px; */width: 36px;height: 36px;/* top: 79px; */"></div>
    			<div class="mu" id="mutemp6" style="/* left: 342px; */width: 33px;height: 33px;/* top: 57px; */"></div>
    			<div class="mu" id="mutemp7" style="/* left: 346px; */width: 30px;height: 30px;/* top: 31px; */"></div>
    			<div class="mu" id="mutemp8" style="/* left: 332px; */width: 27px;height: 27px;/* top: 13px; */"></div>
    			<div class="mu" id="mutemp9" style="/* left: 313px; */width: 24px;height: 24px;/* top: 5px; */"></div>
    			<div class="mu" id="mutemp10" style="/* left: 296px; */width: 23px;height: 23px;/* top: 2px; */"></div>
    			<div class="mu" id="mutemp11" style="/* left: 342px; */width: 22px;height: 22px;/* top: 57px; */"></div>
    			<div class="mu" id="mutemp12" style="/* left: 346px; */width: 21px;height: 21px;/* top: 31px; */"></div>
    			<div class="mu" id="mutemp13" style="/* left: 332px; */width: 20px;height: 20px;/* top: 13px; */"></div>
    			<div class="mu" id="mutemp14" style="/* left: 313px; */width: 19px;height: 19px;/* top: 5px; */"></div>
    			<div class="mu" id="mutemp15" style="/* left: 296px; */width: 18px;height: 18px;/* top: 2px; */"></div>
    			 -->
    			
			</div>

			<!-- 我的标签 -->
			<div class="mytag-container" id="mytag-container">
			<!--<img id="background-rightbar-mytag" src="../image/background1-rightbar.jpg">用来覆盖右边的滚动条 -->
				<div  class="mytag" id="addtag" onclick="addTag()">
					<!-- img src="../image/plus3.jpg"-->
				</div>
				<!-- <div class="mytag"><img src="../image/acclaim-50x173.png"><span>阿斯蒂芬8后</span></div> -->
				<!-- <div class="mytag" id="addtag2" onclick="addTag()" style="width:86px;"> 万有引力 					
					<div class="mytag-selectednumber">123</div>
				</div> -->
				<!-- 引导页：这是我的标签加号上的圆圈 -->
				<img src="../image/guideAddtagCircle.png" id="guideAddtagCircle" onerror="javascript:this.src='http://42.121.136.225:8888/user-pic2.jpg'" 
					style="top: 187px;position: absolute;left: 0px;display:none; width: 65px;">
					
				<!-- 引导页：这是我的标签指向加号的箭头-->
				<img src="../image/guideAddtagArrow.png" id="guideAddtagArrow" onerror="javascript:this.src='http://42.121.136.225:8888/user-pic2.jpg'" 
					style="top: 187px;position: absolute;left: 0px;display:none;width: 65px;">
				
			</div>

			
		</div>
		
		<div class="tag-container" id="tag-container">
		<!--<img id="background-rightbar" src="../image/background1-rightbar.jpg">用来覆盖右边的滚动条 -->
			<!-- CP容器的HTLM标范,不要删,用于css调试 -->
			<div id="cp-show" class="othertag">
				<div id="cp-container" style="/*  position:fixed; */ width:100%;">
				
				<!--div class="cp" id="cpid1" class="selected">CP111111111<div class="cp-selectednumber">988</div></div-->
				
				<!-- <div class="incp" style="position:fixed; top: 800px; left: 100px; height: 73px; width: 73px;">
					<div class="cp-selectednumber">168</div>
					<div style="color:white;line-height: 38px; height: 42px; width: 52.5px; font-size: 15px; top: 15.5px; left: 10.25px;">
					一半
					</div>
					
					
				</div> -->
				
				
				
				
				<!-- <div class="cp" id="cpid2" class="unselected">CP2222222222			</div>-->
				<!-- <div class="cp" id="cpid3" class="unselected">CP3333333			</div>-->
				</div> <!-- END of CP容器的HTLM标范,不要删,用于css调试 -->
		
				<div style="width:100%;height:23%;"></div>
				<!-- start: 叶夷  2017.06.15  添加一个按钮，点击后通过已定义的接口向后台请求一组标签，后台返回后将标签显示出来。点击后继续请求下一页。-->
				<div class="getmoretopics cursor" id="request_cp" onclick="requestCP(userId,requestCPNum,(requestCPNum*(currentRequestedCPPage++)))" style="display:none;">
					<div>更多</div>
				</div>
				
				<!--<button id="request_cp" type="button" onclick="requestCP(userId,requestCPNum,(requestCPNum*(currentRequestedCPPage++)))" style="width:100%;display:none;">请求标签</button>
				 end: 叶夷  -->
			</div>
			
		</div>
		
		<!-- "进入聊天列表按钮"用fixed后,不论放在哪里,都只看屏幕的长宽.-->
		<div class="enterdialogList" id="enterdialogList" onclick="enterMatchUsersPage()" style="display:none;">
			<img src="../image/new-msg-3.png" />
		</div>

		<input type="text" value="请输入cpid" onfocus="if(this.value=='请输入cpid') {this.value=''}" onblur="if(this.value=='') {this.value='请输入cpid'}" id="testNewWebsocketSelectCpId" style="position: absolute;top: 26px;left: 100px;background: #f1f1f1;z-index:999;">
		<input type="text" value="请输入cptext" onfocus="if(this.value=='请输入cptext') {this.value=''}" onblur="if(this.value=='') {this.value='请输入cptext'}" id="testNewWebsocketSelectCpText" style="position: absolute;top: 26px;left: 300px;background: #f1f1f1;z-index:999;">
		<!-- 选中标签并发websocket测试按钮 -->
		<div onclick="requestUserIds()" style="position: absolute;top: 52px;left: 100px;background: #f1f1f1;z-index:999;">
			并发测试按钮 
		</div> 
		<!-- 选中标签性能测试停止按钮-->
		<div onclick="cleartimeout()" style="position: absolute;top: 78px;left: 100px;background: #f1f1f1;">
			选中标签测试停止
		</div>
		<!-- 进入匹配人详情页按钮
		<div onclick="enterMatchUsersPage()" style="position: absolute;top: 52px;left: 100px;background: #f1f1f1;z-index:999;">
			进入匹配人详情页按钮
		</div>-->
		
	</div> <!--End of <div id="showatloaded" class="showatloaded"> -->
	
	<!-- 2017.11.15 叶夷 将修改头像方法模块加入 -->
	<div class="ImageBox" style="left: 48px;top: 48px;display:none;" id="ImageBox">
        <table border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td class="box"><h3 class="tit"><a class="cls" href="javascript:;" onclick="closeImageBox()" title="关闭">关闭</a></h3>
                    <div>
                        <div id="preview">
                            <img id="imghead" width="170" height="170" border="0"><!--无预览时的默认图像-->
                        </div>
                        <a href="javascript:;" class="file-upload">
                            <input id="file" type="file" onchange="previewImage(this)">
                            选择头像 </a>
                        <button id="upload" type="button" onclick="upload()" class="upload">
                            上 传
                        </button>
                    </div></td>
            </tr>
        </table>
    </div>
    <!-- 引导页：这是匹配人头像引导话 -->
    <img src="../image/guideMUBubble.png" id="guideMUBubble" onerror="javascript:this.src='http://42.121.136.225:8888/user-pic2.jpg'" style="width: 60%;display: inline-block;position: absolute;right:0px;display:none;z-index:200;">
    <!-- 关于公司信息 -->
    <div class="footer" style="position: absolute;top: 97%;color:#666666;font-size: 12px;text-align: center;width: 100%;">
			<a style="margin-right: 10px;text-decoration: underline;cursor: pointer;" onclick="enterProfilePage()">关于我们</a>
			<a style="margin-right: 10px;text-decoration: underline;cursor: pointer;" onclick="enterProductPage()">产品介绍</a>
			沪ICP备13012815号-1
		</div>
</body>
	<!-- <script type="text/javascript" src="../script/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="../script/jquery.nicescroll.min.js"></script>
	<script type="text/javascript" src="../script/common-xunta.js"></script>
	<script type="text/javascript" src="../script/common-xunta_web.js"></script>
	<script type="text/javascript" src="../script/popup.js"></script>
	<script type="text/javascript" src="topics_page.js"></script>
	<script type="text/javascript" src="topics_page_web.js"></script>
	<script type="text/javascript" src="../script/popup.js"></script>
	<script type="text/javascript" src="../script/popcontext.js"></script>
	<script type="text/javascript" src="http://xunta.so:3000/javascripts/websocket.io.js"></script> -->
	<!-- 这是为了移动端web的调试 
	<script src="../script/debuggap.js" type="text/javascript"></script>-->
	
	<script type="text/javascript">
		console.log("加载main_page前的时间："+new Date());
		//2018.02.07 叶夷     静态资源的路径动态的创建
		var preUrl=window.location.protocol+"//"+document.domain;//获得静态资源路径的协议+域名
		//将需要的css文件变成js代码生成
		loadCss(preUrl+"/xunta-web/client_code/main_page/topics_page.css");
   		loadCss(preUrl+"/xunta-web/client_code/main_page/topics_page_web.css");
    	loadCss(preUrl+"/xunta-web/client_code/css/common_web.css");
    	loadCss(preUrl+"/xunta-web/client_code/main_page/alter_userimage.css");
    	loadCss(preUrl+"/xunta-web/client_code/css/popup.css");
    	loadCss(preUrl+"/xunta-web/client_code/css/popcontext.css");
    	//将需要的js文件变成js代码生成
		loadJs(preUrl+"/xunta-web/client_code/script/jquery-1.11.3.min.js");
		//loadJs(preUrl+"/xunta-web/client_code/script/jquery.nicescroll.min.js");
		loadJs(preUrl+"/xunta-web/client_code/script/common-xunta.js");
		loadJs(preUrl+"/xunta-web/client_code/script/common-xunta_web.js");
		loadJs(preUrl+"/xunta-web/client_code/script/popup.js");
		loadJs(preUrl+"/xunta-web/client_code/main_page/topics_page.js");
		loadJs(preUrl+"/xunta-web/client_code/main_page/topics_page_web.js");
		loadJs(preUrl+"/xunta-web/client_code/script/popcontext.js");
		loadJs(window.location.protocol+"//xunta.so:3000/javascripts/websocket.io.js");
	
		//2018.02.07  叶夷    动态加载js和 css文件的方法
		function loadJs(src) {
	    	var script = document.createElement('script');
	    	script.type="text/javascript";
	   		script.language = 'javascript';
	    	script.src= src;
	    	document.getElementsByTagName('head')[0].appendChild(script);
		}

		function loadCss(url) {
	   		var link = document.createElement('link');
	    	link.type="text/css";
	    	link.rel = "stylesheet";
	    	link.href = url;
	    	link.media = 'screen';
	    	document.getElementsByTagName('head')[0].appendChild(link);
		}
	
		
		var userId;
		//var unionid;//第三方原生ID
		var userName;
		var userImgUrl;
		
		var pageTitle;
		var adminName;
		var adminImageUrl;
		
		var projectType;
		var domain;
		var userAgent;
		var requestCPNum = 20; //每次请求话题数
		var requestTopMUNum=20;//每次请求用户匹配排名数量
		var currentRequestedCPPage = 0; //page指第几次请求到的返回结果集.0表示还没有请求到.请求成功后,要加1. 
		var unreadObjList=new Array();//2017.08.16 为了装所有的未读信息，然后将数组传给聊天列表
		var firstRequestTopMatchedUsers=true;//2017.09.04  叶夷      判断是否是第一次请求匹配列表
		var firstRequestMyCp=true;//2017.11.13  叶夷      判断是否是第一次请求我的标签
		
		var arrowAnimateStop=false;//判断箭头来回动画是否停止,false是不停止，true是停止
		var isGuideMatchUser=true;//表示这是引导时显示的匹配头像，为了位置固定不变
		console.log("main_page导入文件的时间："+new Date());
		function start(pageParamsStr) {//web:在openWin时通过ready后回调,再跨页执行方式来启动的第一个方法.
			console.log("加载main_page后的时间："+new Date());
			//2018.02.07 判断是否引入jquery文件
			if(typeof jQuery == 'undefined'){
			    window.alert("没有jquery");
			}
			
			//1。11 新增，   显示Log日志后点击return事件返回到话题列表页时是没有参数的，data为''，所以下面加个判断条件，为''就结束该方法  FANG
			retrievePageParams(pageParamsStr); 
			prepareTopicsPage();
			setRootVars();
			
			//匹配人容器的大小设置,为了引导页的显示，先将匹配人容器的大小计算出来
			setMatchUsersContainerSize();
			
			//2018.03.08  叶夷    通过请求请求服务器判断是否出现引导页
			//ifUserInited(userId);
			//2018.04.13  叶夷  先请求推荐标签
			requestCP(userId,requestCPNum,++currentRequestedCPPage);
			
			//2017.08.23 叶夷   各个控件根据屏幕调整
			showMatchedUsers();
			
			//2017.07.04  叶夷  
			//addMPData();//匹配人列表测试
			//requestTopMatchedUsers(userId,requestTopMUNum);//请求用户匹配缩略表,不能放在这里，因为不能同时请求,等请求cp返回且显示之后再请求这个方法，所以此方法放在responseToCPRequest(CP_list)中
			
			//2017.08.09  叶夷  显示我的标签
			//requestMyCP();
			
			chat.init(userId,recevier);//注册用户，及用记接收消息的函数
			console.log("发送消息接口注册用户成功："+userId);
        	log2root("发送消息接口注册用户成功："+userId);
			
			//console.log("测试："+window.screen.width+" "+window.screen.height);
			
		}
		
		//点击 我的头像,询问是否退出登录,如果是,则退出:
		function ask2LogOff(){
			//待叶夷完善:
			logOff();
			
		}
		
		//2017.11.22 叶夷  存储所有匹配人的信息
		var allMatchUserList=new Array();
		
		//发送消息之后服务器返回的消息
        function recevier(obj) {
        	showMsg(obj);
        };
        
        function sendmsg(toUserId,inputValue,handler){
        	console.log("发送消息 - toUserId:"+toUserId+"-inputValue:"+inputValue+"-handler:"+handler);
        	log2root("发送消息- toUserId:"+toUserId+"-inputValue:"+inputValue+"-handler:"+handler);
        	chat.sendPrivateMsg(toUserId,inputValue,handler);
        }
        
        //这是话题消息的返回操作
        function responseTopicMsg(data){
        	var topicOutTime=data.topicOutTime;
        	if(topicOutTime==true || topicOutTime=="true"){//话题失效
        		var topic_id=data.topic_id;
        		var handle=data.handle;
        		if(window.parent.document.getElementById(topic_id)!=null ){//聊天列表打开过
        			exec(topic_id, "topicOutTime('"+handle+"')");
        		}
        	}else{
        		showMsg(data);
            	
            	//在这里发送收到消息接口
            	var msg_id=data.chatmsg_id;
            	var target_topicid=data.window_id;
            	var paraStr =msg_id+ "','"+target_topicid;
    			execRoot("sendmsg_received_confirm('" + paraStr + "')");
        	}
        }
        
        //接收到服务器返回的消息之后的操作，不管是单聊还是话题群聊
        function showMsg(obj){
        	console.log("测试发送消息后台返回结果："+JSON.stringify(obj));
        	log2root("测试发送消息后台返回结果："+JSON.stringify(obj));
			
        		respondeUserId=JSON.stringify(obj.user.userId);
        		user = JSON.stringify(obj.user.name);
        		data = JSON.stringify(obj.data);
        		imgUrl=JSON.stringify(obj.user.imgUrl);
        		//去掉引号
        		respondeUserId= respondeUserId.replace(/\"/g, "");
        		data = data.replace(/\"/g, "");
        		user = user.replace(/\"/g, "");
        		imgUrl=imgUrl.replace(/\"/g, "");
        		
        		var postTimeStr=JSON.stringify(obj.timestr).replace(/\"/g,"");
        		var postTimeLong = new Date((postTimeStr).replace(new RegExp("-","gm"),"/")).getTime();
        		
        		var window_id;//和我聊天的人的id，用来定位聊天页面，后面字段名要变成window_id
        	
        		var msgId = new Date().getTime();				//生成临时发言id.
        		var myOrOther;
        		if (userId === respondeUserId) {
        			window_id=obj.window_id;
        			var msgId=obj.handler;
        			var str = "judgeSelfPosterReturnOrOthers('" + window_id + "','" + msgId + "','" + postTimeLong +"','" +postTimeStr +"')";
        		    execRoot(str);
        		    
        		    //2017.11.22 叶夷 因为自己发送的消息后台没有返回接收着的name,imgurl，所以为了实现聊天列表置顶，用一个数组将匹配人的信息存储，然后在这里可以查找到
        		    var toUserName,toImgUrl;
        		    for(var user in allMatchUserList){
        				if(allMatchUserList[user].userid==window_id){
        					toUserName=allMatchUserList[user].username;
        					toImgUrl=allMatchUserList[user].img_src;
        					break;
        				}
        			}
        		    
        		    if(window.parent.document.getElementById("matchUsers_page")!=null ){//聊天列表打开过,实现置顶
        		    	exec("matchUsers_page", "makeDialogListTop('" + toUserName+"','"+toImgUrl+"','"+window_id +"','"+obj.isTopic+"')");
        		    	exec("matchUsers_page", "updateDialogContentAndTime('','"+toImgUrl+"','"+data+"','"+postTimeStr+"','"+window_id+"')");//更新聊天列表内容和时间
            		}
            	} else { 
            		myOrOther="other";
            		window_id=respondeUserId;
            		//showSelfPoster(user, data,imgUrl,msgId,"other",false);
            		
            		//如果是群聊话题的消息的话user变成topic_name
            		var topic_name=obj.topic_name;
        			if(topic_name!="undefined" && topic_name!=undefined){
        				user=topic_name;
        				window_id=obj.window_id;
        				respondeUserId=window_id;
        			}
            		
            		//聊天列表未读消息提示
            		if(window.parent.document.getElementById("matchUsers_page")!=null ){//聊天列表打开过
            			//在topic模式下unread不光需要topic_name，也需要username
            			exec("matchUsers_page", "unreadMsg('"+user+"','"+imgUrl+"','"+data+"','"+postTimeStr+"','"+respondeUserId+"','"+1+"','"+obj.user.name+"','"+obj.isTopic+"')");
            			exec("matchUsers_page", "makeDialogListTop('"+user+"','"+imgUrl+"','"+respondeUserId+"','"+obj.isTopic+"')");
            		}else{//聊天页表没有打开才将未读信息保存好
            			//2017.08.16   装所有的未读信息，为了将数组传给聊天列表
                		var unreadNum=1;
                		if(unreadObjList.length!=0){
                			var isExit=false;
                			for(var j in unreadObjList){
                				var unReadObj=unreadObjList[j];
                				if(unReadObj.getTouserId()==respondeUserId){//这个用户已经存在，未读数加1
                					unReadObj.unreadNum++;
                					unreadObjList[j]=new unreadObj(user,imgUrl,data,postTimeStr,respondeUserId,unReadObj.unreadNum,obj.user.name);
                					isExit=true;
                					break;
                				}
                			}
                			if(isExit=false){
                				unreadObjList.push(new unreadObj(user,imgUrl,data,postTimeStr,respondeUserId,unreadNum,obj.user.name));
                			}
                		}else{
                			unreadObjList.push(new unreadObj(user,imgUrl,data,postTimeStr,respondeUserId,unreadNum,obj.user.name));
                		}
            		}
            		
            		//首页未读消息提示
            		//exec("main_page", "unreadMsg()");
            		unreadMsg();
            		//提示音
            		//notifyNewMessage(pageTitle);
            		execRoot("notifyNewMessage('"+pageTitle+"')");
            		
            		if(window.parent.document.getElementById(window_id)!=null ){//聊天列表打开过
            			exec(window_id, "showSelfPoster('" + user + "','" + data +"','" +imgUrl+"','" + msgId+"','" + myOrOther+ "','" + false+"','" +obj.msgtype+"')");
            			//加上时间 
                		exec(window_id, "markSendPosterSuccess('" + msgId + "','" + postTimeLong +"','" +postTimeStr+"')");
            		} 
            	}
        }
		
		function setRootVars(){
			execRoot("setTopicsPageOpenMark()");//可能还有其它表示列表页打开的标志.
			execRoot("setCurrentPageId('main_page')");  
		}
		
		function prepareTopicsPage(){
			/*这个地方要修改:允许微信和QQ登录下也可以修改头像.//?
			if(userinfoObj.type!='mobilephone'){//只有手机登录时用户才能修改头像
				$("#alterUserimage").hide();
			}else{
				$("#alterUserimage").show();
			}*/
			$("#userimg").show();
			var userimg=$("#userimg>img");
			userimg.attr("src", userImg);
			
			
			
			//if ( projectType == "WEB" ){
			//	if ( userAgent[0] == "PC" ){
			//		$("#userimage").css("right","32px");//向左让出右侧的滚动条.
			//	}
			//}
			
			//web上不需任何侦听. addListeners(); //这个方法是空的,是为了让topics_page页面与app保持一致.
			setTimeout(function() {
				//开始就显示桔黄色信息是不对的. 应该在ws成功连接后再显示.$("#showonlineoffline>img").attr("src","../image/signal-orange.png");
				//$("body").prepend("<img id='imageundertopiclist' src='../image/imageundertopiclist.jpg'/>");
				$("#imageundertopiclist").fadeIn(1500);//延迟并缓慢显示背景图片.
			}, 1000);
			
			//2017.08.23 叶夷   我的头像和昵称框位置
			//var headerContainerHeight=$(".header-container").css("height");
			//var userImgHeight=$(".userimg").css("height");
			var userImgWidth=parseInt(userimg.css("width"));
			userimg.css("height", userImgWidth+"px");//让头像的高=宽,保证正方形.
			//var userImgMarginTop=parseInt(headerContainerHeight)-parseInt(userImgHeight);
			//$(".userimg").css("margin-top", userImgMarginTop+"px");
			//头像大小位置和用户昵称大小位置
			var headerContainerWidth=$(".header-container").width();
			//var userimgHeight=headerContainerWidth*0.129;
			//userimg.css("width",userimgHeight);//图片高宽一致
			//userimg.css("height",userimgHeight);//图片高宽一致
			
			
			
			
			//2017.10.25 叶夷   用户昵称如果超过3个字则加上...
			userNameTextAdj($("#username"),userName,userImgWidth);//将昵称文字个数及大小的计算及css设置独立放到这个方法中.
			
			//2017.10.25  叶夷   调整信号圆位置
			var showOnLineOffLine=$("#showonlineoffline");
			showOnLineOffLine.show();
			//小绿点大小调整
			//var showOnLineOffLineImgWidth=userimg.width()*0.2438;
			//showOnLineOffLine.find("img").css("width",showOnLineOffLineImgWidth);
			//showOnLineOffLine.find("img").css("height",showOnLineOffLineImgWidth);
			//根据屏幕的宽度调整进入聊天列表按钮的大小
			//var showOnLineOffLineWidth=showOnLineOffLine.find("img").width();
			//var showOnLineOffLineTop=userImgMarginTop-showOnLineOffLineWidth*0.55;
			//var showOnLineOffLineLeft=parseInt($(".userimg").css("margin-left"))+userimgHeight-showOnLineOffLineWidth;
			//showOnLineOffLine.css("top",showOnLineOffLineTop+"px");
			//showOnLineOffLine.css("left",showOnLineOffLineLeft+"px");
			
			//.toastinline刚上线时,  这里会出一个 连接恢复 的提示. 刚上线时的这个提示可以取消.
			//可以 用 设为不显的 方法 来取消. 等头像出来后, 再设为 显示. 头像出来了, 肯定是连接上了
			//$(".toastinline").show();
			//进入聊天列表按钮大小
			/*var enterdialogList=$("#enterdialogList");
			var enterdialogListWidth=headerContainerWidth*0.066;
			enterdialogList.find("img").css("width",enterdialogListWidth);
			enterdialogList.find("img").css("height",enterdialogListWidth);
			*/
			
			createSampleMyTag();//先生成一个mytag元素样本. 并设置css,主要是文字大小. xu
			setMyTagContainerCSS();//根据.mytag高度决定container有容纳三行的高度.
			setAddMyTagCSS(); //根据samplemytag设置加钮的大小.
			setTagContainerHeight();
			//log2root("小绿点位置调整方法开始执行");
			setGreenDotPosition(); 
			//log2root("小绿点位置调整方法执行结束");
		}
		
		//让小绿点刚好骑在头像的肩头上.头像的上边缘刚好在绿点的上下中线位置.
		function setGreenDotPosition(){
			var heightGreenDot = $("#showonlineoffline");
			//log2root("小绿点位置调整方法执行中，top="+(-heightGreenDot.height()/1.8));
			heightGreenDot.css("top",-heightGreenDot.height()/1.8+"px");
		}

		function setAddMyTagCSS(){ //根据samplemytag设置加钮的大小.
			var sampleMyTagObj = $("#samplemytag");
			//var width = parseInt(sampleMyTagObj.css("width"));
			var height = sampleMyTagObj.css("height");
			$("#addtag").css("height",height);
			//$("#addtag").css("width","");
		}
		
		function setMyTagContainerCSS (){//根据.mytag高度决定container有容纳三行的高度.
			var myTagContainer = $(".mytag-container");
			var bodyHeight = $("body").height();
			myTagContainer.css("padding-top",parseInt(bodyHeight*2.8/1000)+"px");
			myTagContainer.css("padding-bottom",parseInt(bodyHeight*2.8/1000)+"px");
			var sampleMyTagObj = $("#samplemytag");
			var myTagTotalHeight = sampleMyTagObj.outerHeight();//包括border不包括margin.
			//各种方法都无法直接获得设为百分数的margin-top值.下面迂回获得: //后来明白,这个百分号问题是因为:它依赖的元素后来被改变了,所以它本身也随着改变,因为总是调不准.
			var sampleMyTagMarginTop = parseFloat(sampleMyTagObj.css("margin-top").replace(/%/,""));//去掉百分号后的数,再转为整数.
			//console.log("=====margin-top======="+sampleMyTagMarginTop*myTagContainer.width()/100);
			sampleMyTagMarginTop = sampleMyTagMarginTop*myTagContainer.width()/100;//获取真实的margin值.margin为百分数时,指父的宽度值.
			myTagTotalHeight = myTagTotalHeight + sampleMyTagMarginTop;
			//var myTagTotalHeight = document.getElementById("samplemytag").clientHeight;//)+parseInt(sampleMyTagObj.offset().top);
			//console.log("=====document.getElementById(samplemytag).clientHeight======="+document.getElementById("samplemytag").clientHeight);
			//console.log("=====sampleMyTagObj.offset().top)======="+sampleMyTagObj.offset().top);
			console.log("=====myTagTotalHeight======="+myTagTotalHeight); 
			var myTagContainerHeight = parseInt(myTagContainer.css("padding-top"))
									+parseInt(myTagContainer.css("padding-bottom"))
									+myTagTotalHeight*3;		
			myTagContainer.css("height",myTagContainerHeight+"px");//然后sampleMyTag可以删掉了.
			console.log("=====myTagContainerHeight======="+myTagContainerHeight); 
		}
		

		function createSampleMyTag(){//用于模拟mytag的实际高度.
			var mytagTextSize=$(".mytag-container").width()/32;
			if(mytagTextSize>15){
				mytagTextSize=15;
			}else if(mytagTextSize<11){
				mytagTextSize=11;
			}
			var sampleMyTag=$("<div></div>").attr("class","mytag").attr("id","samplemytag").text("sample");
			sampleMyTag.css("font-size",mytagTextSize+"px");
			$(".mytag-container").append(sampleMyTag);
			console.log("=====mytagTextSize======="+mytagTextSize); 
			console.log("=====$(sampleMyTag).css======="+sampleMyTag.css("font-size"));
			/*
			var myTagTextLength = length(text);//我的标签的宽度 xu
			var myTagTextSize = parseInt(myTag.css("font-size"))+1;
			var myTagWidth=myTagTextLength*myTagTextSize+20;
			var myTagHeight=myTagTextSize*2-4;

			// 每个我选择的标签的大小适配
			myTag.css("width", myTagWidth+"px");
			myTag.css("height", myTagHeight+"px");
			myTag.css("line-height", myTagHeight+"px");
			*/
		}

		function userNameTextAdj(userNameObj,userNameText,userImgWidth){
			userNameObj.hide();
			//userNameText = "NameOju用户merNameOjumerNammerNam";
			//先隐藏. 设最大文字,最小文字(可以比11px小一些).
			/*先让昵称文字最大
				如果一行,则结束
				如果一行以上,则变小,回到上行,如果文字已最小,则结束.
				
				如果两行以上,则减字到刚好两行.
				如果一行半到两行之间,则结束
				如果一行到一行半之间,则减字到刚好一行.*/
			//var usernameLength=strLength(userNameText);
			var sizeMax = Math.round(userImgWidth/5);//头像下一排最多只能排6个字.两排最多12个字.
			var sizeMin=8;//头像下一排最多只能排6个字.两排最多12个字.
			if (sizeMin >= sizeMax) {sizeMin = sizeMax - 3}
			//var maxTextNumber=0;
			var textSize = sizeMax;
			var lineNum=5;
			for(textSize = sizeMax; ;textSize=textSize-1) {
				lineNum = getTextLineNum(userNameObj,textSize,userNameText);
				if (lineNum == "nochange") {
					textSize=textSize+1;
					lineNum = 3;
					break;
					}
				if (lineNum == 1) {break;}
			}
			
			if (lineNum != 1){
				reduceTextNum(userNameObj,textSize,userNameText,lineNum);
				/*
				var finalUserNmTxt = reduceTextNum(userNameObj,textSize,userNameText);
				finalUserNmTxt = finalUserNmTxt.substr(0,finalUserNmTxt.length-1)+" …";
				setUserNameCSS(userNameObj,textSize,finalUserNmTxt);
				*/
			}
			userNameObj.show();
			
			function getTextLineNum(userNameObj,textSize,text){
				var userNmHeight_Before = parseInt(userNameObj.css("height"));//
				setUserNameCSS(userNameObj,textSize,text);
				var userNmHeight_After = parseInt(userNameObj.css("height"));//
				if (userNmHeight_After == userNmHeight_Before){return "nochange";}		
				if (userNmHeight_After <= (textSize+2)*1.9) {return 1;}
				if (userNmHeight_After > (textSize+2)*1.9 && userNmHeight_After <= (textSize+2)*2.9) {return 2;}
				if (userNmHeight_After > (textSize+2)*2.9) {return 3;}
			}
			
		
			function reduceTextNum(userNameObj,textSize,text,lineNum){
				var textHasEnd = text + "end";
				var lineNumBefore = lineNum;
				//if (lineNumBefore > 3) {lineNumBefore = 3;}//传进来的参数最大就是3,再多行也赋为3.
			
				var lineNumAfter;
				for(var i=0;i<1000;i++) {
					//lineNumBefore = getTextLineNum(userNameObj,textSize,textHasEnd);
					text = text.substr(0,text.length-1);
					lineNumAfter = getTextLineNum(userNameObj,textSize,text+" …");
					if (lineNumAfter < lineNumBefore){
						return text+" …";
					}
				}
			}
			
			function setUserNameCSS(userNameObj,userNameTextSize,text){
				userNameObj.css("font-size",userNameTextSize+"px");
				userNameObj.text(text);	
			}
			
		}

		function retrievePageParams(pageParamsStr){
			if (pageParamsStr == '') {
				toast("打开列表页时发现传递的参数为空.请与开发者联系.");
				return;
			}
			//console.log(pageParamsStr);
			//topicList = JSON.parse(pageParamsStr.topiclist);//注意不能直接parse(pageParamsStr),原因不明.必须parse下面一级的键值对.
			//topicList = pageParamsStr.topiclist;
			//注意不能直接parse(pageParamsStr),原因不明.必须parse下面一级的键值对.
			//var publicVars = JSON.parse(pageParamsStr.publicVars);
			var publicVars = pageParamsStr.publicVars;
			domain = publicVars.domain;
			projectType = publicVars.projectType;
			userAgent = publicVars.userAgent;
			//console.log(userAgent);	console.log(userAgent[0]);	console.log(userAgent[1]);
			pageTitle = publicVars.pageTitle;
		    adminName = publicVars.adminName;
		    adminImageurl = publicVars.adminImageurl;
		    console.log("adminName:"+adminName);
			var userinfoObj = publicVars.userInfo;
			userId = userinfoObj.uid;
			userName = userinfoObj.name;
			userImg = userinfoObj.image;
			//unionid = userinfoObj.unionid;
			//topicList = Parameter.topiclist;
		}
		
		//2017.08.16 叶夷   创建跟我聊天的人的id和未读消息数一一对应的对象，为了保存数组,userNameForTopic是为了群聊消息保存发送者的username
		function unreadObj(user,imgUrl,data,postTimeStr,touserId,unreadNum,userNameForTopic){
			var obj = new Object();
			obj.user=user;
			obj.imgUrl=imgUrl;
			obj.data=data;
			obj.postTimeStr=postTimeStr;
			obj.touserId=touserId;
			obj.unreadNum=unreadNum;
			obj.userNameForTopic=userNameForTopic;
			obj.getUser = function() {
				return this.touserId;
			};
			obj.getData = function() {
				return this.touserId;
			};
			obj.getPostTimeStr = function() {
				return this.touserId;
			};
			obj.getTouserId = function() {
				return this.touserId;
			};
			obj.getUnreadNum = function() {
				return this.unreadNum;
			};
			return obj;
		}
		
	</script>
</html>